# CDIOM 核心业务需求分析文档

## 一、库存管理功能需求分析

### 1.1 功能概述

库存管理是药品出入库管理系统的核心模块，负责实时跟踪和管理所有药品的库存状态。系统采用**按批次管理**的方式，确保药品的可追溯性和合规性，符合GSP（药品经营质量管理规范）要求。

### 1.2 核心功能需求

#### 1.2.1 库存查询功能

**功能描述**：
- 支持多维度查询库存信息，包括按药品名称、批次号、存储位置、有效期等条件筛选
- 实时显示当前库存数量、批次信息、有效期状态
- 支持库存汇总统计（按药品、按批次、按存储位置）

**查询维度**：
1. **按药品查询**：查询指定药品的所有批次库存信息
2. **按批次查询**：查询指定批次号的详细信息
3. **按存储位置查询**：查询指定存储位置的药品清单
4. **按有效期查询**：查询指定有效期范围内的药品
5. **按特殊药品标识查询**：区分普通药品和特殊药品（麻醉药品、精神药品等）

**显示字段**：
- 药品基本信息（名称、规格、剂型、批准文号、生产厂家）
- 批次信息（批次号、生产日期、有效期至）
- 库存数量（当前库存、可用库存）
- 存储信息（存储位置、存储要求）
- 预警状态（近效期预警、库存不足预警）

#### 1.2.2 库存预警功能

**近效期预警**：
- **黄色预警（90-180天）**：药品有效期距当前日期在90-180天之间，系统自动标记为黄色预警
- **红色预警（≤90天）**：药品有效期距当前日期在90天以内，系统自动标记为红色预警
- 预警阈值可通过系统配置参数调整（`expiry_warning_days`、`expiry_critical_days`）
- 预警信息在仪表盘、库存列表、入库验收等环节实时显示

**库存不足预警**：
- 设置药品最低库存阈值（可扩展功能）
- 当库存数量低于阈值时，系统自动预警
- 预警信息推送至仓库管理员

**预警处理流程**：
1. 系统自动计算并标记预警状态
2. 仓库管理员查看预警列表
3. 对近效期药品制定处理方案（优先出库、退货、销毁等）
4. 记录处理结果

#### 1.2.3 库存统计功能

**统计维度**：
1. **按药品统计**：统计每种药品的总库存数量、批次数量
2. **按批次统计**：统计每个批次的库存数量、有效期状态
3. **按存储位置统计**：统计各存储位置的药品分布情况
4. **按特殊药品统计**：区分普通药品和特殊药品的库存情况
5. **按有效期统计**：统计不同有效期区间的药品数量

**统计报表**：
- 库存总量统计
- 近效期药品统计
- 特殊药品库存统计
- 库存周转率分析（可扩展）

#### 1.2.4 库存调整功能（盘盈/盘亏）

**功能描述**：
- 支持库存盘点后的数量调整
- 区分盘盈（PROFIT）和盘亏（LOSS）两种调整类型
- 记录调整原因、操作人、操作时间等信息
- 特殊药品调整需双人操作确认

**调整流程**：
1. **发起调整**：仓库管理员发起库存调整申请
2. **填写信息**：
   - 选择药品和批次
   - 输入调整前数量（系统自动获取）
   - 输入调整后数量（实际盘点数量）
   - 选择调整类型（盘盈/盘亏）
   - 填写调整原因
   - 上传盘点记录照片（可选）
3. **双人确认**（特殊药品）：
   - 特殊药品需第二操作人确认
   - 第二操作人审核调整信息
   - 双方确认后生效
4. **执行调整**：
   - 系统自动更新库存数量
   - 记录调整记录到 `inventory_adjustment` 表
   - 生成调整单号
5. **记录日志**：记录操作日志，便于追溯

**数据约束**：
- 调整后数量必须≥0（数据库CHECK约束）
- 调整数量 = 调整后数量 - 调整前数量
- 盘盈时调整数量为正，盘亏时调整数量为负

### 1.3 库存管理业务流程

```
库存查询流程：
用户登录 → 选择库存管理 → 设置查询条件 → 查看库存列表 → 查看详情/导出报表

库存预警流程：
系统定时计算有效期 → 标记预警状态 → 推送预警信息 → 仓库管理员处理 → 记录处理结果

库存调整流程：
发起调整 → 填写调整信息 → 双人确认（特殊药品） → 系统更新库存 → 记录调整日志
```

### 1.4 数据模型

**核心表：`inventory`（库存表）**
- 主键：`id`
- 唯一约束：`(drug_id, batch_number)` - 同一药品同一批次唯一
- 关键字段：
  - `drug_id`：药品ID（外键关联 `drug_info`）
  - `batch_number`：批次号
  - `quantity`：库存数量（非负约束）
  - `expiry_date`：有效期至
  - `storage_location`：存储位置
  - `production_date`：生产日期
  - `manufacturer`：生产厂家

**关联表：`inventory_adjustment`（库存调整记录表）**
- 记录所有库存调整操作
- 支持盘盈/盘亏两种类型
- 特殊药品需记录第二操作人

---

## 二、入库管理功能需求分析

### 2.1 功能概述

入库管理是药品进入仓库的关键环节，需要严格遵循GSP规范，确保药品质量、效期、批次的准确记录。系统支持**采购订单入库**和**临时入库**两种方式，并实现**效期校验**、**特殊药品双人操作**等合规要求。

### 2.2 核心功能需求

#### 2.2.1 采购订单入库

**功能描述**：
- 关联采购订单进行入库操作
- 支持部分入库（订单分批次到货）
- 自动校验订单信息与到货信息的一致性

**入库流程**：
1. **选择采购订单**：
   - 查询状态为"已发货"（SHIPPED）的采购订单
   - 显示订单明细（药品、数量、单价等）
   - 选择需要入库的订单

2. **到货验收**：
   - 扫描或输入订单条形码获取订单信息
   - 人工核对药品信息是否与订单信息一致
   - 自动填充到货信息：
     - 批次号（必填）
     - 生产日期（必填）
     - 有效期至（必填，系统可自动计算）
     - 到货日期（默认当前日期）
     - 生产厂家（自动填充，可修改）
     - 入库数量（不能超过订单数量）
     - 存储位置（必填）
   - 上传随货同行单（可选，支持图片上传）
   - 备注（是否有误等内容填写）

3. **效期校验**：
   - 系统自动计算有效期距当前日期的天数
   - **PASS（通过）**：有效期≥180天，直接通过
   - **WARNING（警告）**：有效期在90-180天之间，需仓库管理员确认
   - **FORCE（强制入库）**：有效期<90天，需填写强制入库原因
   - 系统记录效期校验状态和原因

4. **特殊药品双人操作**：
   - 如果药品为特殊药品（`is_special = 1`），必须指定第二操作人
   - 第二操作人需登录系统确认入库信息
   - 双方确认后入库操作生效

5. **验收结果**：
   - **合格（QUALIFIED）**：药品验收合格，正常入库
   - **不合格（UNQUALIFIED）**：药品验收不合格，记录不合格原因，不入库

6. **执行入库**：
   - 系统自动生成入库单号（格式：IN+日期+序号，如：IN20260101001）
   - 更新库存表（`inventory`）：
     - 如果该药品该批次已存在，则增加库存数量
     - 如果该药品该批次不存在，则新增库存记录
   - 更新采购订单状态：
     - 如果订单全部入库，订单状态更新为"已入库"（RECEIVED）
     - 如果订单部分入库，订单状态保持"已发货"（SHIPPED）
   - 记录入库记录到 `inbound_record` 表

7. **记录日志**：
   - 记录操作日志（操作人、操作时间、操作内容）
   - 记录入库日志（入库单号、药品、数量、批次等）

#### 2.2.2 临时入库

**功能描述**：
- 支持不关联采购订单的直接入库
- 适用于紧急采购、退货入库、调拨入库等场景
- 流程与采购订单入库类似，但不关联订单

**入库流程**：
1. **选择入库方式**：选择"临时入库"
2. **填写入库信息**：
   - 扫描识别或手动输入药品信息
   - 填写批次号、生产日期、有效期至、入库数量等
   - 填写入库原因（必填）
3. **效期校验**：同采购订单入库
4. **特殊药品双人操作**：同采购订单入库
5. **执行入库**：同采购订单入库（不更新订单状态）

#### 2.2.3 入库记录查询

**功能描述**：
- 支持多条件查询入库记录
- 支持按入库单号、药品名称、批次号、操作人、入库日期等条件筛选
- 支持查看入库详情（包括验收信息、效期校验信息、操作人信息等）

**查询条件**：
- 入库单号
- 药品名称/批准文号
- 批次号
- 操作人
- 入库日期范围
- 验收状态（合格/不合格）
- 效期校验状态（通过/警告/强制入库）
- 关联订单号

#### 2.2.4 入库统计

**功能描述**：
- 统计指定时间范围内的入库情况
- 支持按药品、按操作人、按供应商等维度统计

**统计维度**：
- 入库总数量
- 入库总金额（可扩展）
- 按药品统计入库数量
- 按操作人统计入库次数
- 按供应商统计入库数量
- 不合格入库统计

### 2.3 入库管理业务流程

```
采购订单入库流程：
选择采购订单 → 到货验收 → 填写到货信息 → 效期校验 → 特殊药品双人确认 → 验收结果判定 → 执行入库 → 更新库存 → 更新订单状态 → 记录日志

临时入库流程：
选择临时入库 → 扫描药品信息 → 填写入库信息 → 效期校验 → 特殊药品双人确认 → 验收结果判定 → 执行入库 → 更新库存 → 记录日志

入库记录查询流程：
设置查询条件 → 查看入库列表 → 查看详情 → 导出报表（可扩展）
```

### 2.4 数据模型

**核心表：`inbound_record`（入库记录表）**
- 主键：`id`
- 唯一约束：`record_number`（入库单号）
- 关键字段：
  - `record_number`：入库单号（唯一）
  - `order_id`：关联采购订单ID（可为空，支持临时入库）
  - `drug_id`：药品ID（外键）
  - `batch_number`：批次号
  - `quantity`：入库数量
  - `expiry_date`：有效期至
  - `arrival_date`：到货日期
  - `production_date`：生产日期
  - `manufacturer`：生产厂家
  - `delivery_note_number`：随货同行单编号
  - `delivery_note_image`：随货同行单图片路径
  - `operator_id`：操作人ID（外键）
  - `second_operator_id`：第二操作人ID（特殊药品，外键）
  - `status`：验收状态（QUALIFIED/UNQUALIFIED）
  - `expiry_check_status`：效期校验状态（PASS/WARNING/FORCE）
  - `expiry_check_reason`：效期校验说明

**关联表：**
- `purchase_order`：采购订单表（关联入库）
- `drug_info`：药品信息表（关联药品）
- `inventory`：库存表（更新库存）

### 2.5 业务规则

1. **批次号唯一性**：同一药品同一批次号在库存表中唯一
2. **数量非负约束**：入库数量必须>0
3. **效期校验规则**：
   - 有效期≥180天：自动通过（PASS）
   - 90天≤有效期<180天：需确认（WARNING）
   - 有效期<90天：需填写强制入库原因（FORCE）
4. **特殊药品双人操作**：特殊药品入库必须指定第二操作人并确认
5. **订单入库数量限制**：入库数量不能超过订单未入库数量
6. **入库单号生成规则**：IN + 日期（YYYYMMDD）+ 3位序号

---

## 三、出库管理功能需求分析

### 3.1 功能概述

出库管理是药品离开仓库的关键环节，需要严格遵循审批流程和库存扣减规则。系统支持**医护人员申领出库**的方式，实现**申请-审批-出库**的完整流程，并确保**特殊药品双人审批**、**先进先出（FIFO）**等合规要求。

### 3.2 核心功能需求

#### 3.2.1 出库申请

**功能描述**：
- 医护人员提交药品申领申请
- 支持多药品批量申请
- 支持按科室、用途等分类申请

**申请流程**：
1. **创建申请**：
   - 医护人员登录系统，选择"药品申领"
   - 点击"新建申请"
   - 系统自动生成申领单号（格式：OUT+日期+序号，如：OUT20260101001）

2. **填写申请信息**：
   - 所属科室（必填）
   - 用途说明（必填，如：门诊用药、手术用药等）
   - 备注信息（可选）

3. **添加申领药品**：
   - 搜索或选择药品（支持扫码识别）
   - 输入申领数量（必填，必须>0）
   - 可选择指定批次（可选，不指定则按先进先出原则）
   - 可添加多个药品
   - 系统实时显示当前库存数量，防止超量申请

4. **提交申请**：
   - 检查申请信息完整性
   - 提交申请，状态更新为"待审批"（PENDING）
   - 系统通知仓库管理员有新申请待审批

#### 3.2.2 出库审批

**功能描述**：
- 仓库管理员审批药品申领申请
- 支持通过、驳回操作
- 特殊药品需双人审批

**审批流程**：
1. **查看待审批申请**：
   - 仓库管理员登录系统，查看待审批申请列表
   - 显示申请信息：申领单号、申请人、科室、用途、申请时间、药品明细等

2. **审批检查**：
   - 检查库存是否充足
   - 检查药品是否可用（未过期、未锁定等）
   - 检查申请数量是否合理
   - 检查申请人权限（可扩展）

3. **普通药品审批**：
   - 仓库管理员审核申请信息
   - 选择"通过"或"驳回"
   - 如果驳回，需填写驳回理由
   - 审批后状态更新为"已通过"（APPROVED）或"已驳回"（REJECTED）

4. **特殊药品双人审批**：
   - 如果申请中包含特殊药品，必须指定第二审批人
   - 第一审批人审核后，第二审批人需登录系统确认
   - 第二审批人审核申请信息，确认或驳回
   - 双方确认后，状态更新为"已通过"（APPROVED）

5. **记录审批信息**：
   - 记录审批人、审批时间
   - 记录审批意见（通过/驳回及理由）
   - 更新申请状态

#### 3.2.3 出库执行

**功能描述**：
- 对已审批通过的申请执行出库操作
- 自动扣减库存
- 支持部分出库（申请数量与实际出库数量不一致的情况）

**出库流程**：
1. **选择已审批申请**：
   - 仓库管理员查看"已通过"状态的申请列表
   - 选择需要出库的申请

2. **确认出库信息**：
   - 显示申请明细（药品、申请数量、批次等）
   - 系统自动按先进先出（FIFO）原则推荐出库批次
   - 仓库管理员可手动调整出库批次和数量
   - 填写实际出库数量（默认等于申请数量，可修改）

3. **库存校验**：
   - 系统校验库存是否充足
   - 校验批次是否有效（未过期）
   - 如果库存不足，提示并允许部分出库

4. **执行出库**：
   - 系统自动扣减库存：
     - 按批次扣减库存数量
     - 如果批次库存扣减为0，保留批次记录（数量为0）
     - 更新库存表的 `quantity` 字段
   - 更新出库申请：
     - 状态更新为"已出库"（OUTBOUND）
     - 记录实际出库数量到 `outbound_apply_item.actual_quantity`
     - 记录出库时间
   - 生成出库单（可扩展打印功能）

5. **记录日志**：
   - 记录出库操作日志
   - 记录出库明细（药品、批次、数量、操作人等）

#### 3.2.4 出库记录查询

**功能描述**：
- 支持多条件查询出库记录
- 支持按申领单号、药品名称、申请人、出库日期等条件筛选
- 支持查看出库详情（包括申请信息、审批信息、出库信息等）

**查询条件**：
- 申领单号
- 药品名称/批准文号
- 申请人
- 审批人
- 申请日期范围
- 出库日期范围
- 申请状态（待审批/已通过/已驳回/已出库/已取消）
- 所属科室

#### 3.2.5 出库统计

**功能描述**：
- 统计指定时间范围内的出库情况
- 支持按药品、按申请人、按科室等维度统计

**统计维度**：
- 出库总数量
- 出库总金额（可扩展）
- 按药品统计出库数量
- 按申请人统计出库次数
- 按科室统计出库数量
- 特殊药品出库统计

### 3.3 出库管理业务流程

```
出库申请流程：
医护人员登录 → 创建申领申请 → 填写申请信息 → 添加申领药品 → 提交申请 → 状态：待审批

出库审批流程：
仓库管理员查看待审批申请 → 审批检查 → 普通药品审批/特殊药品双人审批 → 通过/驳回 → 状态：已通过/已驳回

出库执行流程：
选择已审批申请 → 确认出库信息 → 库存校验 → 执行出库 → 扣减库存 → 更新申请状态 → 记录日志

出库记录查询流程：
设置查询条件 → 查看出库列表 → 查看详情 → 导出报表（可扩展）
```

### 3.4 数据模型

**核心表：`outbound_apply`（出库申请表）**
- 主键：`id`
- 唯一约束：`apply_number`（申领单号）
- 关键字段：
  - `apply_number`：申领单号（唯一）
  - `applicant_id`：申请人ID（外键，医护人员）
  - `department`：所属科室
  - `purpose`：用途
  - `status`：申请状态（PENDING/APPROVED/REJECTED/OUTBOUND/CANCELLED）
  - `approver_id`：审批人ID（外键，仓库管理员）
  - `second_approver_id`：第二审批人ID（特殊药品，外键）
  - `approve_time`：审批时间
  - `reject_reason`：驳回理由
  - `outbound_time`：出库时间

**核心表：`outbound_apply_item`（出库申请明细表）**
- 主键：`id`
- 关键字段：
  - `apply_id`：申请ID（外键）
  - `drug_id`：药品ID（外键）
  - `batch_number`：批次号（可选，不指定则按FIFO）
  - `quantity`：申领数量
  - `actual_quantity`：实际出库数量（出库时填写）

**关联表：**
- `drug_info`：药品信息表（关联药品）
- `inventory`：库存表（扣减库存）

### 3.5 业务规则

1. **申请状态流转**：
   - PENDING（待审批）→ APPROVED（已通过）/ REJECTED（已驳回）
   - APPROVED（已通过）→ OUTBOUND（已出库）
   - 任何状态 → CANCELLED（已取消，申请人可取消）

2. **库存扣减规则**：
   - 按批次扣减，优先使用先进先出（FIFO）原则
   - 如果指定批次，则从指定批次扣减
   - 如果未指定批次，系统自动选择最早到期的批次
   - 库存数量不能为负（数据库约束）

3. **特殊药品双人审批**：
   - 如果申请中包含特殊药品（`is_special = 1`），必须指定第二审批人
   - 第二审批人必须与第一审批人不同
   - 双方确认后审批生效

4. **部分出库规则**：
   - 支持实际出库数量小于申请数量
   - 记录实际出库数量到 `actual_quantity` 字段
   - 如果部分出库，申请状态仍为"已出库"，但明细中标记实际数量

5. **申领单号生成规则**：OUT + 日期（YYYYMMDD）+ 3位序号

6. **库存不足处理**：
   - 如果库存不足，允许部分出库
   - 剩余申请数量可后续补出库（可扩展功能）

---

## 四、核心业务流程整合

### 4.1 完整业务流程

```
采购订单 → 发货 → 入库验收 → 更新库存 → 库存管理 → 出库申请 → 出库审批 → 出库执行 → 扣减库存
```

### 4.2 数据流转关系

1. **入库 → 库存**：
   - 入库记录（`inbound_record`）生成后，自动更新库存表（`inventory`）
   - 如果批次已存在，增加数量；如果批次不存在，新增记录

2. **库存 → 出库**：
   - 出库执行时，从库存表（`inventory`）扣减数量
   - 记录出库明细到 `outbound_apply_item`

3. **库存调整**：
   - 库存调整（`inventory_adjustment`）直接更新库存表（`inventory`）
   - 支持盘盈/盘亏两种类型

### 4.3 关键业务规则总结

1. **批次管理**：所有药品按批次管理，批次号唯一
2. **先进先出（FIFO）**：出库时优先使用最早到期的批次
3. **效期校验**：入库时自动校验有效期，不符合要求需确认或填写原因
4. **特殊药品双人操作**：特殊药品的入库、出库、库存调整需双人确认
5. **库存非负约束**：库存数量不能为负，数据库层面保证
6. **操作日志**：所有关键操作记录日志，符合GSP规范要求

---

## 五、合规性要求

### 5.1 GSP规范要求

1. **药品追溯**：支持通过国家本位码、追溯码、商品码追溯药品信息
2. **批次管理**：所有药品按批次管理，确保可追溯
3. **效期管理**：自动计算和预警近效期药品
4. **双人操作**：特殊药品（麻醉药品、精神药品）需双人操作
5. **操作记录**：所有操作记录不可删除，保留5年

### 5.2 数据完整性要求

1. **外键约束**：所有外键设置约束，保证数据完整性
2. **唯一约束**：关键字段设置唯一约束（入库单号、申领单号、批次号等）
3. **非负约束**：库存数量、出库数量等设置非负约束
4. **必填字段**：关键业务字段设置为必填

### 5.3 审计要求

1. **操作日志**：记录所有关键操作的详细日志
2. **操作人记录**：记录操作人、审批人、第二操作人等
3. **操作时间**：记录操作时间，支持时间范围查询
4. **操作内容**：记录操作内容，包括修改前后的数据对比（可扩展）

---

## 六、扩展功能建议

### 6.1 库存管理扩展

1. **最低库存预警**：设置药品最低库存阈值，低于阈值自动预警
2. **库存周转率分析**：分析药品周转率，优化库存结构
3. **ABC分类管理**：按药品价值和使用频率分类管理
4. **库存成本核算**：支持按批次成本核算库存价值

### 6.2 入库管理扩展

1. **批量入库**：支持Excel导入批量入库
2. **入库质量检验**：扩展质量检验流程和记录
3. **供应商评价**：记录供应商到货及时率、质量合格率等

### 6.3 出库管理扩展

1. **出库计划**：支持制定出库计划，提前准备
2. **出库打印**：支持打印出库单、标签等
3. **出库退回**：支持出库后退回处理
4. **出库统计分析**：按科室、药品、时间等维度统计分析

---

**文档版本**：v1.0  
**最后更新**：2026年1月12日  
**文档作者**：CDIOM开发团队

