# CDIOM 核心业务需求分析文档

## 目录

- [一、登录与权限核心需求](#一登录与权限核心需求)
- [二、药品基础信息管理功能](#二药品基础信息管理功能)
- [三、库存管理功能需求分析](#三库存管理功能需求分析)
- [四、入库管理功能需求分析](#四入库管理功能需求分析)
- [五、出库管理功能需求分析](#五出库管理功能需求分析)
- [六、采购订单管理功能](#六采购订单管理功能)
- [七、供应商管理功能](#七供应商管理功能)
- [八、操作日志与追溯功能](#八操作日志与追溯功能)
- [九、数据可视化功能](#九数据可视化功能)
- [十、各角色界面需求](#十各角色界面需求)
- [十一、合规与技术适配需求](#十一合规与技术适配需求)
- [十二、核心业务流程整合](#十二核心业务流程整合)
- [十三、扩展功能建议](#十三扩展功能建议)

---

## 一、登录与权限核心需求

### 1.1 登录功能需求

#### 1.1.1 基础登录

**功能描述**：
- 支持用户名或手机号与密码组合登录
- 密码采用BCrypt加密存储（强度10轮）
- 登录失败统一提示"用户名或密码错误"，不区分具体错误类型，避免信息泄露
- 支持记住登录状态（Token有效期8小时）

**登录流程**：
1. 用户输入用户名/手机号和密码
2. 系统验证用户信息（用户名/手机号、密码、用户状态）
3. 验证通过后生成JWT Token（有效期8小时）
4. Token存储到Cookie（key: `cdiom_token`）
5. 返回用户信息和权限列表

**安全控制**：
- 连续5次登录失败自动锁定账号1小时
- 锁定期间无法登录，需系统管理员后台解锁
- 登录日志记录（IP地址、浏览器、操作系统、登录地点）

#### 1.1.2 身份认证

**JWT Token机制**：
- Token有效期：8小时
- Token存储：Cookie（key: `cdiom_token`）
- Token格式：包含用户ID、用户名、角色代码
- 前端所有接口请求自动携带Token（通过Axios拦截器）
- 后端通过JWT过滤器验证Token有效性
- 未授权请求直接返回401，前端自动跳转至登录页

**Token过期处理**：
- Token过期后自动清除本地存储的用户信息
- 强制登出，需重新登录验证
- 前端自动检测Token过期并跳转登录页

#### 1.1.3 权限关联

**权限加载机制**：
- 登录成功后系统自动加载当前用户所属角色
- 自动加载角色对应的操作权限
- 支持用户直接拥有权限（细粒度权限控制）
- 前端根据权限动态渲染菜单和操作按钮
- 无权限的功能模块默认隐藏

**权限查询逻辑**：
1. 先查询角色权限（从 `sys_role_permission` 表）
2. 再查询用户直接权限（从 `sys_user_permission` 表）
3. 合并去重后返回最终权限列表
4. 超级管理员（角色ID=6）自动拥有所有权限（通配符 `*`）

### 1.2 权限管控需求（基于RBAC模型）

#### 1.2.1 系统管理员

**权限范围**：
- 用户管理：新增、编辑、禁用、解锁用户
- 角色管理：创建、编辑、删除角色
- 权限分配：为各角色分配操作权限
- 系统配置：配置系统核心参数（如效期阈值、日志保留期）
- 通知公告：发布、编辑、删除通知公告
- 日志查看：查看操作日志和登录日志

**权限限制**：
- 无药品出入库、采购等业务操作权限
- 不能直接修改业务数据
- 不能查看其他用户的业务数据

#### 1.2.2 仓库管理员

**权限范围**：
- 药品管理：药品信息的新增、编辑、查询、删除
- 入库管理：入库验收、效期校验、特殊药品双人操作确认
- 出库管理：出库审批、出库执行、库存扣减
- 库存管理：库存查询、库存调整（盘盈/盘亏）、近效期预警处理
- 供应商审核：审核供应商资质
- 日志查看：查看操作日志和库存数据

**权限限制**：
- 不可修改用户权限及直接创建采购订单
- 不能修改系统配置参数
- 不能查看其他角色的业务数据

#### 1.2.3 采购专员

**权限范围**：
- 供应商管理：供应商信息的增删改查
- 采购订单：创建、编辑、发送采购订单，跟踪订单进度
- 库存查看：查看库存数据以制定采购计划
- 药品查看：查看药品基础信息

**权限限制**：
- 无入库验收、出库审批权限
- 不能修改药品信息
- 不能进行库存调整

#### 1.2.4 医护人员

**权限范围**：
- 药品查询：查询药品基础信息
- 出库申领：发起药品申领、填写申领数量和用途（临床使用/应急备用）
- 进度查询：查看自身申领单进度及历史申领记录

**权限限制**：
- 无药品信息修改、库存调整权限
- 不能查看其他用户的申领记录
- 不能进行入库、出库操作

#### 1.2.5 供应商

**权限范围**：
- 订单查看：查看与自身相关的采购订单
- 订单操作：订单确认、拒绝或发货操作
- 物流填写：填写发货物流单号
- 订单统计：查看自身订单统计和趋势

**权限限制**：
- 无系统配置及其他无关数据查看权限
- 只能查看和操作自己的订单
- 不能查看其他供应商的订单

---

## 二、药品基础信息管理功能

### 2.1 功能概述

药品基础信息管理是系统的数据基础，负责维护所有药品的基本信息，支持多种方式录入药品信息，确保数据的准确性和完整性。

### 2.2 核心功能需求

#### 2.2.1 信息维护

**功能描述**：
- 支持药品信息的新增、编辑、查询、删除（逻辑删除）
- 核心字段包括：
  - 药品ID、国家本位码、通用名称、剂型、规格
  - 批准文号、供应商名称（通过关联表）、有效期
  - 是否特殊药品（麻醉/精神类）、存储要求（常温/冷藏）
  - 存储位置、生产厂家、商品码、追溯码等
- 所有必填字段需填写完整后方可提交

**数据校验**：
- 药品国家本位码设置唯一约束，重复编码无法提交
- 有效期格式强制校验为YYYY-MM-DD，不符合格式则提示错误
- 特殊药品必须填写存储设施备注（如专用库房编号），否则无法保存
- 批准文号格式校验（可扩展）

#### 2.2.2 扫码关联

**功能描述**：
- 适配通用USB扫码枪（HID键盘模式）
- 扫描药品条形码后自动关联药品基础信息
- 支持扫描：国家本位码、商品码、追溯码
- 自动填充至对应表单字段，避免手工录入错误
- 提高操作效率，减少录入错误

**扫码流程**：
1. 点击"扫码识别"按钮
2. 将扫码枪对准药品条形码
3. 系统自动识别并查询药品信息
4. 先查询本地数据库，未找到则调用第三方API
5. 自动填充表单字段，用户可手动核对修改

#### 2.2.3 分类管理

**药品分类**：
- **普通药品**：常规药品，无特殊管理要求
- **特殊药品**：麻醉药品、精神药品等，需双人操作
- **冷藏药品**：需低温存储，需明确标注存储温度范围（如2-8℃）

**分类标注**：
- 按"普通药品/特殊药品/冷藏药品"进行分类标注
- 特殊药品自动关联双人操作规则
- 冷藏药品需明确标注存储温度范围
- 便于仓储管理和合规追溯

#### 2.2.4 第三方API集成

**万维易源API（1468-4）**：
- 根据药品名称查询药品详细信息
- 根据批准文号查询药品详细信息
- 返回字段：批准文号、生产厂家、剂型、规格、有效期、存储要求等

**极速数据API（JisuAPI）**：
- 根据商品码/本位码/追溯码查询药品详细信息
- 返回字段：国家本位码、条形码、描述、包装规格等

**数据合并逻辑**：
1. 通过药品名称/批准文号查询：先调用万维易源API，再自动调用极速数据API补充信息
2. 通过商品码/本位码/追溯码查询：先查本地数据库，未找到则调用极速数据API
3. 自动合并两个API的数据，极速数据API的规格字段会替换万维易源API的规格

#### 2.2.5 供应商关联

**多对多关系**：
- 一个药品可以有多个供应商
- 每个供应商可以为同一药品设置不同单价
- 通过 `supplier_drug` 关联表管理
- 支持添加、删除、更新供应商-药品关联
- 支持根据供应商ID查询关联的药品列表

---

## 三、库存管理功能需求分析

### 3.1 功能概述

库存管理是药品出入库管理系统的核心模块，负责实时跟踪和管理所有药品的库存状态。系统采用**按批次管理**的方式，确保药品的可追溯性和合规性，符合GSP（药品经营质量管理规范）要求。

### 3.2 核心功能需求

#### 3.2.1 库存查询功能

**功能描述**：
- 支持多维度查询库存信息，包括按药品名称、批次号、存储位置、有效期等条件筛选
- 实时显示当前库存数量、批次信息、有效期状态
- 支持库存汇总统计（按药品、按批次、按存储位置）

**查询维度**：
1. **按药品查询**：查询指定药品的所有批次库存信息
2. **按批次查询**：查询指定批次号的详细信息
3. **按存储位置查询**：查询指定存储位置的药品清单
4. **按有效期查询**：查询指定有效期范围内的药品
5. **按特殊药品标识查询**：区分普通药品和特殊药品（麻醉药品、精神药品等）

**显示字段**：
- 药品基本信息（名称、规格、剂型、批准文号、生产厂家）
- 批次信息（批次号、生产日期、有效期至）
- 库存数量（当前库存、可用库存）
- 存储信息（存储位置、存储要求）
- 预警状态（近效期预警、库存不足预警）

#### 3.2.2 库存预警功能

**近效期预警**：
- **黄色预警（90-180天）**：药品有效期距当前日期在90-180天之间，系统自动标记为黄色预警
- **红色预警（≤90天）**：药品有效期距当前日期在90天以内，系统自动标记为红色预警
- 预警阈值可通过系统配置参数调整（`expiry_warning_days`、`expiry_critical_days`）
- 预警信息在仪表盘、库存列表、入库验收等环节实时显示

**库存不足预警**：
- 设置药品最低库存阈值（可扩展功能）
- 当库存数量低于阈值时，系统自动预警
- 预警信息推送至仓库管理员

**预警处理流程**：
1. 系统自动计算并标记预警状态
2. 仓库管理员查看预警列表
3. 对近效期药品制定处理方案（优先出库、退货、销毁等）
4. 记录处理结果

#### 3.2.3 库存统计功能

**统计维度**：
1. **按药品统计**：统计每种药品的总库存数量、批次数量
2. **按批次统计**：统计每个批次的库存数量、有效期状态
3. **按存储位置统计**：统计各存储位置的药品分布情况
4. **按特殊药品统计**：区分普通药品和特殊药品的库存情况
5. **按有效期统计**：统计不同有效期区间的药品数量

**统计报表**：
- 库存总量统计
- 近效期药品统计
- 特殊药品库存统计
- 库存周转率分析（可扩展）

#### 3.2.4 库存调整功能（盘盈/盘亏）

**功能描述**：
- 支持库存盘点后的数量调整
- 区分盘盈（PROFIT）和盘亏（LOSS）两种调整类型
- 记录调整原因、操作人、操作时间等信息
- 特殊药品调整需双人操作确认

**调整流程**：
1. **发起调整**：仓库管理员发起库存调整申请
2. **填写信息**：
   - 选择药品和批次
   - 输入调整前数量（系统自动获取）
   - 输入调整后数量（实际盘点数量）
   - 选择调整类型（盘盈/盘亏）
   - 填写调整原因
   - 上传盘点记录照片（可选）
3. **双人确认**（特殊药品）：
   - 特殊药品需第二操作人确认
   - 第二操作人审核调整信息
   - 双方确认后生效
4. **执行调整**：
   - 系统自动更新库存数量
   - 记录调整记录到 `inventory_adjustment` 表
   - 生成调整单号
5. **记录日志**：记录操作日志，便于追溯

**数据约束**：
- 调整后数量必须≥0（数据库CHECK约束）
- 调整数量 = 调整后数量 - 调整前数量
- 盘盈时调整数量为正，盘亏时调整数量为负

### 3.3 库存管理业务流程

```
库存查询流程：
用户登录 → 选择库存管理 → 设置查询条件 → 查看库存列表 → 查看详情/导出报表

库存预警流程：
系统定时计算有效期 → 标记预警状态 → 推送预警信息 → 仓库管理员处理 → 记录处理结果

库存调整流程：
发起调整 → 填写调整信息 → 双人确认（特殊药品） → 系统更新库存 → 记录调整日志
```

### 3.4 数据模型

**核心表：`inventory`（库存表）**
- 主键：`id`
- 唯一约束：`(drug_id, batch_number)` - 同一药品同一批次唯一
- 关键字段：
  - `drug_id`：药品ID（外键关联 `drug_info`）
  - `batch_number`：批次号
  - `quantity`：库存数量（非负约束）
  - `expiry_date`：有效期至
  - `storage_location`：存储位置
  - `production_date`：生产日期
  - `manufacturer`：生产厂家

**关联表：`inventory_adjustment`（库存调整记录表）**
- 记录所有库存调整操作
- 支持盘盈/盘亏两种类型
- 特殊药品需记录第二操作人

---

## 四、入库管理功能需求分析

### 4.1 功能概述

入库管理是药品进入仓库的关键环节，需要严格遵循GSP规范，确保药品质量、效期、批次的准确记录。系统支持**采购订单入库**和**临时入库**两种方式，并实现**效期校验**、**特殊药品双人操作**等合规要求。

### 4.2 核心功能需求

#### 4.2.1 采购订单入库

**功能描述**：
- 关联采购订单进行入库操作
- 支持部分入库（订单分批次到货）
- 自动校验订单信息与到货信息的一致性

**入库流程**：
1. **选择采购订单**：
   - 查询状态为"已发货"（SHIPPED）的采购订单
   - 显示订单明细（药品、数量、单价等）
   - 选择需要入库的订单

2. **到货验收**：
   - 扫描或输入订单条形码获取订单信息
   - 人工核对药品信息是否与订单信息一致
   - 自动填充到货信息：
     - 批次号（必填）
     - 生产日期（必填）
     - 有效期至（必填，系统可自动计算）
     - 到货日期（默认当前日期）
     - 生产厂家（自动填充，可修改）
     - 入库数量（不能超过订单数量）
     - 存储位置（必填）
   - 上传随货同行单（可选，支持图片上传）
   - 备注（是否有误等内容填写）

3. **效期校验**：
   - 系统自动计算有效期距当前日期的天数
   - **PASS（通过）**：有效期≥180天，直接通过
   - **WARNING（警告）**：有效期在90-180天之间，需仓库管理员确认
   - **FORCE（强制入库）**：有效期<90天，需填写强制入库原因
   - 系统记录效期校验状态和原因

4. **特殊药品双人操作**：
   - 如果药品为特殊药品（`is_special = 1`），必须指定第二操作人
   - 第二操作人需登录系统确认入库信息
   - 双方确认后入库操作生效

5. **验收结果**：
   - **合格（QUALIFIED）**：药品验收合格，正常入库
   - **不合格（UNQUALIFIED）**：药品验收不合格，记录不合格原因，不入库

6. **执行入库**：
   - 系统自动生成入库单号（格式：IN+日期+序号，如：IN20260101001）
   - 更新库存表（`inventory`）：
     - 如果该药品该批次已存在，则增加库存数量
     - 如果该药品该批次不存在，则新增库存记录
   - 更新采购订单状态：
     - 如果订单全部入库，订单状态更新为"已入库"（RECEIVED）
     - 如果订单部分入库，订单状态保持"已发货"（SHIPPED）
   - 记录入库记录到 `inbound_record` 表

7. **记录日志**：
   - 记录操作日志（操作人、操作时间、操作内容）
   - 记录入库日志（入库单号、药品、数量、批次等）

#### 4.2.2 临时入库

**功能描述**：
- 支持不关联采购订单的直接入库
- 适用于紧急采购、退货入库、调拨入库等场景
- 流程与采购订单入库类似，但不关联订单

**入库流程**：
1. **选择入库方式**：选择"临时入库"
2. **填写入库信息**：
   - 扫描识别或手动输入药品信息
   - 填写批次号、生产日期、有效期至、入库数量等
   - 填写入库原因（必填）
3. **效期校验**：同采购订单入库
4. **特殊药品双人操作**：同采购订单入库
5. **执行入库**：同采购订单入库（不更新订单状态）

#### 4.2.3 入库记录查询

**功能描述**：
- 支持多条件查询入库记录
- 支持按入库单号、药品名称、批次号、操作人、入库日期等条件筛选
- 支持查看入库详情（包括验收信息、效期校验信息、操作人信息等）

**查询条件**：
- 入库单号
- 药品名称/批准文号
- 批次号
- 操作人
- 入库日期范围
- 验收状态（合格/不合格）
- 效期校验状态（通过/警告/强制入库）
- 关联订单号

#### 4.2.4 入库统计

**功能描述**：
- 统计指定时间范围内的入库情况
- 支持按药品、按操作人、按供应商等维度统计

**统计维度**：
- 入库总数量
- 入库总金额（可扩展）
- 按药品统计入库数量
- 按操作人统计入库次数
- 按供应商统计入库数量
- 不合格入库统计

### 4.3 入库管理业务流程

```
采购订单入库流程：
选择采购订单 → 到货验收 → 填写到货信息 → 效期校验 → 特殊药品双人确认 → 验收结果判定 → 执行入库 → 更新库存 → 更新订单状态 → 记录日志

临时入库流程：
选择临时入库 → 扫描药品信息 → 填写入库信息 → 效期校验 → 特殊药品双人确认 → 验收结果判定 → 执行入库 → 更新库存 → 记录日志

入库记录查询流程：
设置查询条件 → 查看入库列表 → 查看详情 → 导出报表（可扩展）
```

### 4.4 数据模型

**核心表：`inbound_record`（入库记录表）**
- 主键：`id`
- 唯一约束：`record_number`（入库单号）
- 关键字段：
  - `record_number`：入库单号（唯一）
  - `order_id`：关联采购订单ID（可为空，支持临时入库）
  - `drug_id`：药品ID（外键）
  - `batch_number`：批次号
  - `quantity`：入库数量
  - `expiry_date`：有效期至
  - `arrival_date`：到货日期
  - `production_date`：生产日期
  - `manufacturer`：生产厂家
  - `delivery_note_number`：随货同行单编号
  - `delivery_note_image`：随货同行单图片路径
  - `operator_id`：操作人ID（外键）
  - `second_operator_id`：第二操作人ID（特殊药品，外键）
  - `status`：验收状态（QUALIFIED/UNQUALIFIED）
  - `expiry_check_status`：效期校验状态（PASS/WARNING/FORCE）
  - `expiry_check_reason`：效期校验说明

**关联表：**
- `purchase_order`：采购订单表（关联入库）
- `drug_info`：药品信息表（关联药品）
- `inventory`：库存表（更新库存）

### 4.5 业务规则

1. **批次号唯一性**：同一药品同一批次号在库存表中唯一
2. **数量非负约束**：入库数量必须>0
3. **效期校验规则**：
   - 有效期≥180天：自动通过（PASS）
   - 90天≤有效期<180天：需确认（WARNING）
   - 有效期<90天：需填写强制入库原因（FORCE）
4. **特殊药品双人操作**：特殊药品入库必须指定第二操作人并确认
5. **订单入库数量限制**：入库数量不能超过订单未入库数量
6. **入库单号生成规则**：IN + 日期（YYYYMMDD）+ 3位序号

---

## 五、出库管理功能需求分析

### 5.1 功能概述

出库管理是药品离开仓库的关键环节，需要严格遵循审批流程和库存扣减规则。系统支持**医护人员申领出库**的方式，实现**申请-审批-出库**的完整流程，并确保**特殊药品双人审批**、**先进先出（FIFO）**等合规要求。

### 5.2 核心功能需求

#### 5.2.1 出库申请

**功能描述**：
- 医护人员提交药品申领申请
- 支持多药品批量申请
- 支持按科室、用途等分类申请

**申请流程**：
1. **创建申请**：
   - 医护人员登录系统，选择"药品申领"
   - 点击"新建申请"
   - 系统自动生成申领单号（格式：OUT+日期+序号，如：OUT20260101001）

2. **填写申请信息**：
   - 所属科室（必填）
   - 用途说明（必填，如：门诊用药、手术用药等）
   - 备注信息（可选）

3. **添加申领药品**：
   - 搜索或选择药品（支持扫码识别）
   - 输入申领数量（必填，必须>0）
   - 可选择指定批次（可选，不指定则按先进先出原则）
   - 可添加多个药品
   - 系统实时显示当前库存数量，防止超量申请

4. **提交申请**：
   - 检查申请信息完整性
   - 提交申请，状态更新为"待审批"（PENDING）
   - 系统通知仓库管理员有新申请待审批

#### 5.2.2 出库审批

**功能描述**：
- 仓库管理员审批药品申领申请
- 支持通过、驳回操作
- 特殊药品需双人审批

**审批流程**：
1. **查看待审批申请**：
   - 仓库管理员登录系统，查看待审批申请列表
   - 显示申请信息：申领单号、申请人、科室、用途、申请时间、药品明细等

2. **审批检查**：
   - 检查库存是否充足
   - 检查药品是否可用（未过期、未锁定等）
   - 检查申请数量是否合理
   - 检查申请人权限（可扩展）

3. **普通药品审批**：
   - 仓库管理员审核申请信息
   - 选择"通过"或"驳回"
   - 如果驳回，需填写驳回理由
   - 审批后状态更新为"已通过"（APPROVED）或"已驳回"（REJECTED）

4. **特殊药品双人审批**：
   - 如果申请中包含特殊药品，必须指定第二审批人
   - 第一审批人审核后，第二审批人需登录系统确认
   - 第二审批人审核申请信息，确认或驳回
   - 双方确认后，状态更新为"已通过"（APPROVED）

5. **记录审批信息**：
   - 记录审批人、审批时间
   - 记录审批意见（通过/驳回及理由）
   - 更新申请状态

#### 5.2.3 出库执行

**功能描述**：
- 对已审批通过的申请执行出库操作
- 自动扣减库存
- 支持部分出库（申请数量与实际出库数量不一致的情况）

**出库流程**：
1. **选择已审批申请**：
   - 仓库管理员查看"已通过"状态的申请列表
   - 选择需要出库的申请

2. **确认出库信息**：
   - 显示申请明细（药品、申请数量、批次等）
   - 系统自动按先进先出（FIFO）原则推荐出库批次
   - 仓库管理员可手动调整出库批次和数量
   - 填写实际出库数量（默认等于申请数量，可修改）

3. **库存校验**：
   - 系统校验库存是否充足
   - 校验批次是否有效（未过期）
   - 如果库存不足，提示并允许部分出库

4. **执行出库**：
   - 系统自动扣减库存：
     - 按批次扣减库存数量
     - 如果批次库存扣减为0，保留批次记录（数量为0）
     - 更新库存表的 `quantity` 字段
   - 更新出库申请：
     - 状态更新为"已出库"（OUTBOUND）
     - 记录实际出库数量到 `outbound_apply_item.actual_quantity`
     - 记录出库时间
   - 生成出库单（可扩展打印功能）

5. **记录日志**：
   - 记录出库操作日志
   - 记录出库明细（药品、批次、数量、操作人等）

#### 5.2.4 出库记录查询

**功能描述**：
- 支持多条件查询出库记录
- 支持按申领单号、药品名称、申请人、出库日期等条件筛选
- 支持查看出库详情（包括申请信息、审批信息、出库信息等）

**查询条件**：
- 申领单号
- 药品名称/批准文号
- 申请人
- 审批人
- 申请日期范围
- 出库日期范围
- 申请状态（待审批/已通过/已驳回/已出库/已取消）
- 所属科室

#### 5.2.5 出库统计

**功能描述**：
- 统计指定时间范围内的出库情况
- 支持按药品、按申请人、按科室等维度统计

**统计维度**：
- 出库总数量
- 出库总金额（可扩展）
- 按药品统计出库数量
- 按申请人统计出库次数
- 按科室统计出库数量
- 特殊药品出库统计

### 5.3 出库管理业务流程

```
出库申请流程：
医护人员登录 → 创建申领申请 → 填写申请信息 → 添加申领药品 → 提交申请 → 状态：待审批

出库审批流程：
仓库管理员查看待审批申请 → 审批检查 → 普通药品审批/特殊药品双人审批 → 通过/驳回 → 状态：已通过/已驳回

出库执行流程：
选择已审批申请 → 确认出库信息 → 库存校验 → 执行出库 → 扣减库存 → 更新申请状态 → 记录日志

出库记录查询流程：
设置查询条件 → 查看出库列表 → 查看详情 → 导出报表（可扩展）
```

### 5.4 数据模型

**核心表：`outbound_apply`（出库申请表）**
- 主键：`id`
- 唯一约束：`apply_number`（申领单号）
- 关键字段：
  - `apply_number`：申领单号（唯一）
  - `applicant_id`：申请人ID（外键，医护人员）
  - `department`：所属科室
  - `purpose`：用途
  - `status`：申请状态（PENDING/APPROVED/REJECTED/OUTBOUND/CANCELLED）
  - `approver_id`：审批人ID（外键，仓库管理员）
  - `second_approver_id`：第二审批人ID（特殊药品，外键）
  - `approve_time`：审批时间
  - `reject_reason`：驳回理由
  - `outbound_time`：出库时间

**核心表：`outbound_apply_item`（出库申请明细表）**
- 主键：`id`
- 关键字段：
  - `apply_id`：申请ID（外键）
  - `drug_id`：药品ID（外键）
  - `batch_number`：批次号（可选，不指定则按FIFO）
  - `quantity`：申领数量
  - `actual_quantity`：实际出库数量（出库时填写）

**关联表：**
- `drug_info`：药品信息表（关联药品）
- `inventory`：库存表（扣减库存）

### 5.5 业务规则

1. **申请状态流转**：
   - PENDING（待审批）→ APPROVED（已通过）/ REJECTED（已驳回）
   - APPROVED（已通过）→ OUTBOUND（已出库）
   - 任何状态 → CANCELLED（已取消，申请人可取消）

2. **库存扣减规则**：
   - 按批次扣减，优先使用先进先出（FIFO）原则
   - 如果指定批次，则从指定批次扣减
   - 如果未指定批次，系统自动选择最早到期的批次
   - 库存数量不能为负（数据库约束）

3. **特殊药品双人审批**：
   - 如果申请中包含特殊药品（`is_special = 1`），必须指定第二审批人
   - 第二审批人必须与第一审批人不同
   - 双方确认后审批生效

4. **部分出库规则**：
   - 支持实际出库数量小于申请数量
   - 记录实际出库数量到 `actual_quantity` 字段
   - 如果部分出库，申请状态仍为"已出库"，但明细中标记实际数量

5. **申领单号生成规则**：OUT + 日期（YYYYMMDD）+ 3位序号

6. **库存不足处理**：
   - 如果库存不足，允许部分出库
   - 剩余申请数量可后续补出库（可扩展功能）

---

## 六、采购订单管理功能

### 6.1 功能概述

采购订单管理是药品采购流程的核心环节，负责创建、流转、跟踪采购订单，实现采购专员与供应商之间的协作，确保采购流程的完整性和可追溯性。

### 6.2 核心功能需求

#### 6.2.1 订单创建

**功能描述**：
- 采购专员根据库存预警或科室需求创建采购订单
- 选择供应商、药品、采购数量、预计交货日期
- 填写订单备注（如特殊存储要求）
- 系统自动生成唯一采购订单编号（格式：ORD+日期+序号，如：ORD20260101001）
- 生成对应的条形码（Code128格式），支持下载和打印

**订单明细**：
- 支持一个订单包含多个药品
- 每个药品明细包含：药品ID、采购数量、单价、小计金额
- 系统自动计算订单总金额
- 支持根据供应商动态加载关联的药品列表

**订单状态**：
- 订单创建后状态默认为"待确认"（PENDING）
- 订单提交后系统自动推送至对应供应商账号

#### 6.2.2 订单流转

**状态流转**：
- **PENDING（待确认）**：订单已创建，等待供应商确认
- **REJECTED（已拒绝）**：供应商拒绝订单，需填写拒绝理由
- **CONFIRMED（待发货）**：供应商确认订单，等待发货
- **SHIPPED（已发货）**：供应商已发货，填写物流单号
- **RECEIVED（已入库）**：订单全部入库后自动更新为已入库
- **CANCELLED（已取消）**：订单被取消

**供应商操作**：
- 供应商登录后可查看订单详情
- 选择"确认"（订单状态更新为"待发货"）或"拒绝"（需填写拒绝理由）
- 操作结果实时同步至采购专员

#### 6.2.3 进度跟踪

**功能描述**：
- 采购专员可按订单状态筛选查询订单
- 供应商发货后需填写物流单号和发货日期
- 采购专员可通过物流单号跟踪物流信息
- 系统记录物流状态更新时间

**跟踪信息**：
- 订单创建时间、确认时间、发货时间、入库时间
- 物流单号、发货日期
- 订单状态变更历史（可扩展）

#### 6.2.4 关联入库

**功能描述**：
- 供应商发货后，系统自动向仓库管理员推送"待入库提醒"
- 仓库管理员进行入库验收时，可通过订单编号关联对应采购订单
- 实现"采购订单-入库验收"流程闭环
- 入库后自动更新订单状态（全部入库后更新为"已入库"）

**条形码功能**：
- 订单创建后自动生成条形码（Code128格式）
- 支持条形码Base64图片和下载
- 仓库管理员可通过扫描订单条形码快速关联订单信息

---

## 七、供应商管理功能

### 7.1 功能概述

供应商管理负责维护供应商信息，管理供应商资质，支持供应商与药品的多对多关联，确保采购流程的合规性和可追溯性。

### 7.2 核心功能需求

#### 7.2.1 信息维护

**功能描述**：
- 采购专员可新增、编辑、查询、禁用供应商信息
- 核心字段包括：
  - 供应商ID、名称、联系人、手机号、地址
  - 统一社会信用代码、资质证书（图片上传）
  - 合作状态（启用/禁用）、备注信息

**数据管理**：
- 支持供应商信息的增删改查
- 支持按名称、联系人、合作状态等条件筛选
- 支持供应商禁用（禁用后无法创建新采购订单，但保留历史订单数据）

#### 7.2.2 资质审核

**功能描述**：
- 新增供应商时需上传《药品经营许可证》《GSP认证证书》图片
- 提交后由系统管理员或仓库管理员审核
- 审核通过后供应商状态变更为"启用"，方可创建采购订单
- 审核未通过需注明驳回理由，供应商信息处于"待完善"状态

**资质管理**：
- 支持资质证书图片上传（JPG/PNG格式，单张大小≤5MB）
- 供应商资质证书有效期临近时（≤30天），系统自动提醒采购专员跟进更新
- 资质证书信息记录到供应商表，支持查看和更新

#### 7.2.3 动态管理

**功能描述**：
- 支持切换供应商合作状态（启用/禁用）
- 禁用后无法创建新采购订单，但保留历史订单数据供查询
- 支持供应商-药品关联管理（多对多关系）
- 每个供应商可以为同一药品设置不同单价

**关联管理**：
- 支持添加供应商-药品关联（支持设置单价）
- 支持删除供应商-药品关联
- 支持更新供应商-药品关联的单价
- 支持根据供应商ID查询关联的药品列表

---

## 八、操作日志与追溯功能

### 8.1 功能概述

操作日志与追溯功能是系统合规性的核心保障，负责记录所有核心操作，确保全程可追溯，符合GSP规范要求。

### 8.2 核心功能需求

#### 8.2.1 日志记录

**功能描述**：
- 系统自动记录所有核心操作，包括：
  - 登录登出、用户管理操作
  - 药品信息修改、入库验收、出库审批
  - 库存调整、订单操作、供应商管理
  - 系统配置修改、权限分配等

**日志字段**：
- 操作人（用户ID、用户名）
- 操作时间（精确到秒）
- 操作类型（INSERT/UPDATE/DELETE/SELECT）
- 操作内容（操作描述、数据变更前后对比）
- IP地址、浏览器、操作系统
- 操作结果（成功/失败）

#### 8.2.2 追溯查询

**功能描述**：
- 支持按操作人、时间范围、操作类型、药品名称等条件筛选日志
- 日志数据保留5年（符合GSP规范）
- 不可删除或修改，支持导出查询结果供合规审计

**查询条件**：
- 操作人（用户ID、用户名）
- 时间范围（开始时间、结束时间）
- 操作类型（INSERT/UPDATE/DELETE/SELECT）
- 操作模块（药品管理、入库管理、出库管理等）
- 药品名称、订单编号等业务关键字

#### 8.2.3 数据快照

**功能描述**：
- 入库验收、出库审批、库存调整等操作发生时，自动保存数据变更前的快照
- 如调整前库存数量、修改前药品信息等
- 可通过日志关联查看数据变更历史，实现全链路追溯

**快照内容**：
- 操作前的数据状态（JSON格式存储）
- 操作后的数据状态（JSON格式存储）
- 变更字段对比（可扩展）
- 关联的业务单据编号（入库单号、出库单号等）

---

## 九、数据可视化功能

### 9.1 功能概述

数据可视化功能为不同角色提供定制化的仪表盘，展示关键业务数据和统计信息，帮助用户快速了解系统运行状态和业务情况。

### 9.2 角色定制仪表盘

#### 9.2.1 仓库管理员仪表盘

**展示内容**：
- **近效期预警卡片**：分黄色预警（90-180天）、红色预警（≤90天）
- **待办任务列表**：待入库订单数、待审批出库数
- **今日出入库统计**：今日入库数量、今日出库数量（柱状图）
- **库存总量统计**：当前库存总量、药品种类数
- **出入库趋势图表**：最近7天出入库数量趋势（折线图）

**数据来源**：
- 近效期预警：从库存表查询有效期距当前日期≤180天的药品
- 待办任务：从采购订单表查询状态为"已发货"的订单，从出库申请表查询状态为"待审批"的申请
- 今日统计：从入库记录表和出库申请表查询今日数据
- 趋势图表：统计最近7天的出入库数据

#### 9.2.2 采购专员仪表盘

**展示内容**：
- **订单统计卡片**：总订单数、待确认订单数、待发货订单数、已入库订单数
- **供应商统计**：合作供应商数量、活跃供应商数量
- **订单趋势图表**：最近7天订单数量趋势（折线图）
- **需采购药品清单**：库存低于预警线的药品列表（可扩展）

**数据来源**：
- 订单统计：从采购订单表按状态统计
- 供应商统计：从供应商表统计合作状态为"启用"的供应商
- 趋势图表：统计最近7天的订单创建数据

#### 9.2.3 医护人员仪表盘

**展示内容**：
- **申领统计卡片**：总申领单数、待审批申领单数、已通过申领单数、已出库申领单数
- **状态分布图表**：申领单状态分布（饼图）
- **申领趋势图表**：最近7天申领数量趋势（折线图）
- **常用药品收藏栏**：收藏的常用药品列表（可扩展）

**数据来源**：
- 申领统计：从出库申请表按状态统计（仅统计当前用户的申领）
- 状态分布：统计各状态的申领单数量
- 趋势图表：统计最近7天的申领数据

#### 9.2.4 供应商仪表盘

**展示内容**：
- **订单统计卡片**：总订单数、待确认订单数、待发货订单数、已发货订单数
- **状态分布图表**：订单状态分布（饼图）
- **金额统计卡片**：总金额、待确认金额、已确认金额
- **订单趋势图表**：最近7天订单数量趋势（折线图）

**数据来源**：
- 订单统计：从采购订单表按状态统计（仅统计当前供应商的订单）
- 金额统计：统计订单总金额、各状态订单金额
- 趋势图表：统计最近7天的订单数据

#### 9.2.5 系统管理员仪表盘

**展示内容**：
- **系统运行状态卡片**：在线用户数、近24小时操作量
- **角色分布统计**：各角色用户数量分布（饼图）
- **操作频次统计**：各模块操作频次统计（柱状图）
- **登录趋势图表**：最近7天登录次数趋势（折线图）
- **操作日志统计**：最近7天操作日志统计（折线图）

**数据来源**：
- 在线用户数：从登录日志表统计最近1小时内有登录记录的用户
- 操作量：从操作日志表统计近24小时的操作记录数
- 角色分布：从用户表和角色表统计各角色用户数量
- 趋势图表：统计最近7天的登录和操作数据

### 9.3 数据筛选与导出

**功能描述**：
- 所有列表页（药品列表、订单列表、库存列表、日志列表）支持关键字搜索和多条件筛选
- 支持Excel格式导出数据（可扩展）
- 导出文件自动添加"导出人+导出时间"水印（可扩展）

**筛选功能**：
- 关键字搜索：支持药品名称、订单编号、用户名等关键字搜索
- 多条件筛选：支持按时间范围、状态、类型等多条件组合筛选
- 实时筛选：筛选条件变更后实时更新列表数据

---

## 十、各角色界面需求

### 10.1 系统管理员界面

#### 10.1.1 首页

**展示内容**：
- 系统运行状态卡片（在线用户数、近24小时操作量）
- 合规配置面板（效期阈值、日志保留期设置）
- 角色分布饼图
- 操作频次统计柱状图
- 登录趋势折线图

#### 10.1.2 用户管理页

**功能**：
- 用户列表（展示用户名、角色、手机号、状态、创建时间）
- 支持新增、编辑、禁用、解锁操作
- 分配角色时可勾选对应权限项
- 支持超级管理员管理（启用/停用、邮箱验证）

#### 10.1.3 系统配置页

**功能**：
- 维护扫码枪适配参数、JWT过期时间、近效期预警阈值
- 查看系统日志导出记录
- 配置文件上传存储路径
- 系统参数配置管理

#### 10.1.4 界面风格

- 简洁行政风，以蓝色为主色调
- 操作按钮突出"保存""审核"核心动作
- 隐藏业务操作相关菜单，聚焦系统管理功能

### 10.2 仓库管理员界面

#### 10.2.1 首页

**展示内容**：
- 近效期预警卡片（分黄色/红色预警）
- 待办任务列表（待入库/待出库审批）
- 今日出入库统计柱状图
- 库存总量统计卡片
- 出入库趋势图表

#### 10.2.2 药品管理页

**功能**：
- 药品列表（支持扫码搜索、多条件筛选）
- 新增/编辑药品表单（特殊药品字段标红提示）
- 药品分类筛选标签（普通/特殊/冷藏）
- 支持四种新增药品方式：手动输入、扫码识别、药品名称搜索、批准文号搜索

#### 10.2.3 入库验收页

**功能**：
- 待入库订单列表
- 扫码验收界面（扫描订单条形码自动填充订单信息）
- 效期校验弹窗（PASS/WARNING/FORCE）
- 不合格药品登记表单（含异常情况描述和图片上传）
- 特殊药品双人操作确认

#### 10.2.4 出库审批页

**功能**：
- 申领单列表（按"待审批/已审批/已驳回"筛选）
- 出库详情页（显示库存余量、药品批次信息）
- 审批按钮需二次确认
- 特殊药品显示双人审批入口

#### 10.2.5 库存管理页

**功能**：
- 库存列表（支持按效期、类型、存储位置筛选）
- 库存调整表单（盘盈/盘亏）
- 近效期药品导出按钮（可扩展）
- 库存预警设置入口

#### 10.2.6 界面风格

- 高效操作风，表单布局紧凑
- 扫码区域突出显示
- 合规校验结果（如效期不足、特殊药品提示）以醒目颜色标注
- 核心操作按钮（审批/验收）标红强调

### 10.3 采购专员界面

#### 10.3.1 首页

**展示内容**：
- 采购订单进度统计卡片（待确认/待发货/已入库）
- 库存预警提醒（需采购药品清单，可扩展）
- 近30天采购量折线图
- 供应商合作活跃度统计

#### 10.3.2 供应商管理页

**功能**：
- 供应商列表（展示名称、联系人、合作状态、资质有效期）
- 新增供应商表单（资质上传区域）
- 供应商详情页（含历史订单记录）
- 供应商-药品关联管理

#### 10.3.3 采购订单页

**功能**：
- 订单列表（支持按状态、时间、供应商筛选）
- 创建订单表单（关联药品与供应商，自动带出库存余量）
- 订单详情页（物流单号输入框、订单状态跟踪）
- 订单条形码生成和下载

#### 10.3.4 界面风格

- 商务协作风，订单状态用不同颜色标注（待确认-蓝色/已发货-黄色/已入库-绿色）
- 支持批量操作（如批量发送订单，可扩展）
- 表单字段逻辑关联，减少重复录入

### 10.4 医护人员界面

#### 10.4.1 首页

**展示内容**：
- 药品申领快捷入口
- 待审批申领单提醒
- 常用药品收藏栏（可扩展）
- 近30天申领统计卡片
- 申领状态分布图表

#### 10.4.2 药品申领页

**功能**：
- 药品搜索框（支持按名称/规格模糊查询）
- 申领表单（选择药品、填写数量/用途/科室）
- 申领预览页（显示库存状态、预计出库时间）
- 支持扫码识别药品

#### 10.4.3 进度查询页

**功能**：
- 申领记录列表（按"待审批/已通过/已驳回/已出库"筛选）
- 申领详情页（显示审批意见、出库时间、批次号）
- 支持取消申领（状态为"待审批"时）

#### 10.4.4 界面风格

- 简洁易用风，减少专业字段展示
- 突出"申领"核心动作
- 进度查询结果直观易懂，用图标区分不同状态的申领单

### 10.5 供应商界面

#### 10.5.1 首页

**展示内容**：
- 待处理订单提醒卡片
- 近30天订单统计图表
- 已发货订单跟踪列表
- 订单状态分布图表
- 订单金额统计

#### 10.5.2 订单管理页

**功能**：
- 订单列表（仅显示与自身相关的订单，支持按状态筛选）
- 订单确认/拒绝弹窗（需填写理由）
- 发货信息填写页（物流单号、发货日期输入）
- 订单详情查看

#### 10.5.3 界面风格

- 轻量化操作风，仅保留订单相关功能模块
- 隐藏无关系统菜单
- 操作流程简化为"查看订单-确认/拒绝-填写发货信息"三步
- 表单填写项简洁明了

---

## 十一、合规与技术适配需求

### 11.1 合规强制需求

#### 11.1.1 效期管控

**功能要求**：
- 入库时自动校验效期，不足180天需手动确认并留痕
- 出库时优先推荐近效期药品（FIFO原则）
- 禁止过期药品入库和出库
- 系统自动计算有效期距当前日期的天数
- 效期校验状态记录到入库记录表，支持追溯

#### 11.1.2 特殊药品管理

**功能要求**：
- 特殊药品的入库、出库、库存调整均需双人操作并留痕
- 操作日志中明确标注双人操作ID和时间
- 支持合规审计追溯
- 特殊药品在库存列表中单独分类显示
- 标注专用存储专区位置，便于快速定位和管理

#### 11.1.3 操作记录不可篡改

**功能要求**：
- 所有操作日志、数据变更快照采用只读模式存储
- 数据库层面设置权限控制，禁止删除或修改历史记录
- 保留5年以上供查询（符合GSP规范）
- 操作日志表设置只读权限，仅允许INSERT操作

#### 11.1.4 数据一致性

**功能要求**：
- 出入库操作与库存数据实时同步
- 采用事务机制确保操作原子性，避免库存数据异常
- 库存数量始终保持非负（数据库CHECK约束）
- 使用悲观锁和原子更新操作，确保并发安全

### 11.2 技术适配需求

#### 11.2.1 跨终端适配

**功能要求**：
- 前端支持PC（Windows/Mac）、Pad（iPad/安卓平板）响应式布局
- Pad端优化表单触控体验，按钮尺寸放大适配触控操作
- 界面元素自动适配不同屏幕尺寸
- 使用Ant Design响应式栅格系统

#### 11.2.2 扫码枪适配

**功能要求**：
- 支持通用USB扫码枪（HID键盘模式）
- 扫码后自动聚焦下一字段
- 支持连续扫码录入多药品信息
- 扫码数据自动去重和格式校验
- 扫码区域突出显示，提供友好的扫码提示

**实现方式**（待实现）：
- 前端监听键盘输入事件
- 识别扫码枪输入模式（快速连续输入）
- 自动填充到对应表单字段
- 支持扫码后自动提交或跳转

#### 11.2.3 性能要求

**功能要求**：
- 核心接口（登录、出入库操作、库存查询）响应时间≤3秒
- 支持单次入库100+药品批量扫码处理（可扩展）
- 页面加载无明显卡顿
- 数据库查询优化（索引、分页、缓存）

#### 11.2.4 文件存储

**功能要求**：
- 图片上传支持JPG/PNG格式，单张文件≤5MB
- 用于存储随货同行单、供应商资质、异常药品照片等
- 存储路径可通过系统配置修改
- 按日期分类存储（yyyy/MM/dd目录结构）
- 生成唯一文件名（UUID），防止文件名冲突

#### 11.2.5 数据安全

**功能要求**：
- 后端密码采用BCrypt加密存储（强度10轮）
- 敏感数据传输采用HTTPS协议（生产环境）
- 前端本地存储的Token和用户信息进行简单加密处理
- 防止本地窃取，Token存储在Cookie中（HttpOnly建议设置为true）

---

## 十二、核心业务流程整合

### 12.1 完整业务流程

```
采购订单 → 发货 → 入库验收 → 更新库存 → 库存管理 → 出库申请 → 出库审批 → 出库执行 → 扣减库存
```

### 12.2 数据流转关系

1. **入库 → 库存**：
   - 入库记录（`inbound_record`）生成后，自动更新库存表（`inventory`）
   - 如果批次已存在，增加数量；如果批次不存在，新增记录

2. **库存 → 出库**：
   - 出库执行时，从库存表（`inventory`）扣减数量
   - 记录出库明细到 `outbound_apply_item`

3. **库存调整**：
   - 库存调整（`inventory_adjustment`）直接更新库存表（`inventory`）
   - 支持盘盈/盘亏两种类型

### 12.3 关键业务规则总结

1. **批次管理**：所有药品按批次管理，批次号唯一
2. **先进先出（FIFO）**：出库时优先使用最早到期的批次
3. **效期校验**：入库时自动校验有效期，不符合要求需确认或填写原因
4. **特殊药品双人操作**：特殊药品的入库、出库、库存调整需双人确认
5. **库存非负约束**：库存数量不能为负，数据库层面保证
6. **操作日志**：所有关键操作记录日志，符合GSP规范要求

---

## 十三、扩展功能建议

### 13.1 库存管理扩展

1. **最低库存预警**：设置药品最低库存阈值，低于阈值自动预警
2. **库存周转率分析**：分析药品周转率，优化库存结构
3. **ABC分类管理**：按药品价值和使用频率分类管理
4. **库存成本核算**：支持按批次成本核算库存价值

### 13.2 入库管理扩展

1. **批量入库**：支持Excel导入批量入库
2. **入库质量检验**：扩展质量检验流程和记录
3. **供应商评价**：记录供应商到货及时率、质量合格率等

### 13.3 出库管理扩展

1. **出库计划**：支持制定出库计划，提前准备
2. **出库打印**：支持打印出库单、标签等
3. **出库退回**：支持出库后退回处理
4. **出库统计分析**：按科室、药品、时间等维度统计分析

---

## 文档信息

**文档创建时间**：2026年1月12日 18:00:25  
**最后修改时间**：2026年1月14日 18:38:31  
**当前更新时间**：2026年1月14日 20:00:00  
**文档版本**：v2.0  
**文档作者**：CDIOM开发团队

---

## 文件变更历史

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| v1.0 | 2026-01-12 18:00:25 | 初始版本创建，包含库存管理、入库管理、出库管理的完整需求分析 |
| v1.1 | 2026-01-13 09:45:56 | 更新业务需求细节 |
| v1.2 | 2026-01-14 16:17:17 | 添加文档时间记录和文件变更历史 |
| v2.0 | 2026-01-14 20:00:00 | 完善核心业务需求分析文档，新增以下章节：<br>1. 登录与权限核心需求（详细说明登录功能、身份认证、权限管控）<br>2. 药品基础信息管理功能（信息维护、扫码关联、分类管理、第三方API集成）<br>3. 采购订单管理功能（订单创建、流转、进度跟踪、关联入库）<br>4. 供应商管理功能（信息维护、资质审核、动态管理）<br>5. 操作日志与追溯功能（日志记录、追溯查询、数据快照）<br>6. 数据可视化功能（5种角色定制仪表盘、数据筛选与导出）<br>7. 各角色界面需求（系统管理员、仓库管理员、采购专员、医护人员、供应商界面详细说明）<br>8. 合规与技术适配需求（合规强制需求、技术适配需求）<br>基于项目实际完成情况和用户提供的详细需求说明，全面完善文档内容 |

