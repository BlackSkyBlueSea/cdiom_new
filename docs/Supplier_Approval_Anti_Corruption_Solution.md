# 供应商准入审批与廉政风险防控解决方案

## 一、问题背景

在药品采购管理中，如果仅由仓库管理员审核协议、资质并主导采购相关操作，存在以下廉政风险：

1. **价格舞弊**：与供应商串通，签订高于市场均价的协议，从中收受回扣
2. **资质审核放水**：对供应商资质把关不严，准入不合格供应商
3. **协议暗箱操作**：私下签订补充协议，系统中不存档或篡改协议信息
4. **供应商垄断**：长期准入单一供应商，排斥优质低价的其他供应商

## 二、解决方案概述

本方案通过 **"分权制衡+全程留痕+监督审计"** 的管控体系，从根源上规避廉政风险：

### 核心原则
- **不让权力集中在单一角色手中**
- **每个环节都有独立的审核和记录**
- **所有操作全程留痕，不可篡改**

## 三、分权制衡的审批流程

### 3.1 审批流程设计

```
步骤1：采购员发起供应商准入申请
       ↓ （提交资质+报价单）
步骤2：仓库管理员负责资质真实性核验
       ↓ （仅核对资质原件与复印件是否一致，不可单独审批通过）
步骤3：采购/财务负责人负责价格合理性审核
       ↓ （对比集采价/市场均价/历史协议价，价格异常则驳回）
步骤4：超级管理员/合规岗负责最终审批
       ↓ （确认流程合规性，存档协议）
步骤5：审批通过后，协议价格才允许录入系统
```

### 3.2 各角色权限配置（基于权限标签）

| 角色 | 分配的权限标签 | 可操作权限 | 禁止操作权限 |
|------|--------------|------------|--------------|
| **采购专员**<br>（角色ID=3） | `supplier:approval:apply`<br>`supplier:approval:view`<br>`supplier:approval:price`<br>`price:agreement:view`<br>`price:history:view` | 1. 发起供应商准入申请<br>2. 提交资质/报价单<br>3. 价格审核<br>4. 查看审批进度和日志<br>5. 查看价格协议和历史 | 1. 资质核验<br>2. 最终审批协议<br>3. 价格协议管理 |
| **仓库管理员**<br>（角色ID=2） | `supplier:approval:quality`<br>`supplier:approval:price`<br>`supplier:approval:final`<br>`supplier:approval:view`<br>`price:agreement:manage`<br>`price:agreement:view`<br>`price:warning:config`<br>`price:history:view` | 1. 核验供应商资质<br>2. 价格审核<br>3. 最终审批协议<br>4. 价格协议管理<br>5. 价格预警配置<br>6. 查看审批和价格历史 | 1. 发起供应商准入申请（通常由采购专员发起） |
| **系统管理员**<br>（角色ID=1） | 无审批权限 | 1. 系统功能维护<br>2. 用户管理、角色管理、配置管理 | 1. 不参与业务审批流程 |
| **超级管理员**<br>（角色ID=6） | 所有权限（通配符"*"） | 1. 拥有所有权限<br>2. 主要用于系统测试和维护 | 无（但不应用于日常业务操作） |

## 四、系统约束功能

### 4.1 价格预警校验

**功能描述**：
- 录入协议价格时，系统自动对比**集采中标价、历史最低协议价、市场参考价**
- 若协议价高于参考价的阈值（默认10%），系统自动触发预警
- 严重预警（超过20%）时，强制要求填写"价格差异说明"，否则无法提交审批

**实现方式**：
- 价格预警配置表（`price_warning_config`）存储参考价格和阈值
- 支持药品特定配置和全局配置
- 自动计算价格差异率并判断预警级别

### 4.2 供应商黑名单机制

**功能描述**：
- 系统建立供应商黑名单，录入存在违规记录的供应商
- 发起准入申请时，系统自动校验，黑名单供应商直接驳回
- 支持按供应商名称或统一社会信用代码匹配

**实现方式**：
- 供应商黑名单表（`supplier_blacklist`）
- 支持完全禁止和部分药品禁止两种类型
- 支持有效期管理

### 4.3 协议文档防篡改

**功能描述**：
- 上传的协议文档自动生成**电子水印**（包含上传人、上传时间、协议编号）
- 文档一旦存档，**不允许修改/删除**
- 仅可新增补充协议（补充协议需走同样的审批流程）

**实现方式**：
- 文件上传时记录上传人、上传时间等信息
- 协议文档URL存储在审批申请和协议表中
- 通过权限控制禁止修改已存档的协议

### 4.4 全流程操作日志

**功能描述**：
- 记录每一个环节的操作人、操作时间、操作内容
- 日志不可删除、不可篡改
- 支持审计部门一键导出

**实现方式**：
- 审批流程日志表（`supplier_approval_log`）记录每个审批环节
- 操作日志表（`operation_log`）记录所有系统操作
- 所有日志记录操作人、IP地址、操作时间等详细信息

## 五、数据库设计

### 5.1 核心表结构

#### 供应商准入审批申请表（supplier_approval_application）
- 存储审批申请的基本信息
- 记录每个审批环节的审核人和审核结果
- 支持新供应商准入和协议修改两种类型

#### 供应商准入审批明细表（supplier_approval_item）
- 存储协议价格明细
- 记录每个药品的申请价格、参考价格、价格差异率
- 记录价格预警级别和差异说明

#### 供应商黑名单表（supplier_blacklist）
- 存储被列入黑名单的供应商信息
- 支持完全禁止和部分药品禁止
- 支持有效期管理

#### 价格预警配置表（price_warning_config）
- 存储参考价格和预警阈值
- 支持药品特定配置和全局配置
- 支持动态调整预警阈值

#### 审批流程日志表（supplier_approval_log）
- 详细记录每个审批环节的操作
- 记录操作人、操作时间、操作结果、操作意见
- 支持完整的审批流程追溯

## 六、API接口

### 6.1 审批流程接口

- `POST /api/v1/supplier-approvals` - 创建审批申请（采购员）
- `POST /api/v1/supplier-approvals/{id}/quality-check` - 资质核验（仓库管理员）
- `POST /api/v1/supplier-approvals/{id}/price-review` - 价格审核（采购/财务负责人）
- `POST /api/v1/supplier-approvals/{id}/final-approve` - 最终审批（超级管理员）
- `GET /api/v1/supplier-approvals/{id}` - 查询申请详情
- `GET /api/v1/supplier-approvals/{id}/logs` - 查询审批日志

### 6.2 权限控制（基于权限标签）

每个接口都有严格的权限校验，通过权限标签而非角色ID控制：
- 资质核验：需要 `supplier:approval:quality` 权限（仓库管理员拥有）
- 价格审核：需要 `supplier:approval:price` 权限（采购专员和仓库管理员都拥有）
- 最终审批：需要 `supplier:approval:final` 权限（仓库管理员拥有）
- 发起申请：需要 `supplier:approval:apply` 权限（采购专员拥有）

**优势**：
- 不依赖硬编码的角色ID
- 通过权限配置灵活调整
- 支持用户直接权限，实现特殊配置

## 七、使用场景

### 场景1：新供应商准入

1. **采购员发起申请**：填写供应商信息、上传资质文件、提交报价单
2. **系统自动检查**：检查黑名单、价格预警
3. **仓库管理员核验资质**：核对资质原件与复印件是否一致，填写核验意见
4. **采购/财务负责人审核价格**：查看价格预警信息，审核价格合理性
5. **超级管理员最终审批**：确认流程合规性，审批通过后协议生效
6. **系统自动记录**：所有环节的操作都记录在审批日志中

### 场景2：价格调整

1. **采购员发起协议修改申请**：关联已有供应商，提交新价格
2. **系统价格预警**：自动对比参考价格，触发预警（如有）
3. **仓库管理员核验**：确认资质仍然有效
4. **价格审核**：审核新价格的合理性，查看价格差异说明
5. **最终审批**：审批通过后，新价格生效，旧价格保留在历史记录中

## 八、安全保障措施

### 8.1 流程保障
- **多环节审批**：至少3个独立环节，每个环节由不同角色负责
- **状态流转控制**：严格按照状态流转，不允许跳步或回退
- **角色权限隔离**：每个角色只能操作自己负责的环节

### 8.2 技术保障
- **价格预警**：自动检测价格异常，强制填写差异说明
- **黑名单拦截**：黑名单供应商无法创建申请
- **操作日志**：所有操作全程留痕，不可删除、不可篡改
- **IP地址记录**：记录每次操作的IP地址，便于追溯

### 8.3 监督保障
- **审批日志查询**：支持查询完整的审批流程日志
- **操作日志审计**：支持按时间、操作人、操作类型查询操作日志
- **价格历史追溯**：支持查询价格变更历史，追溯价格来源

## 九、优势总结

1. **分权制衡**：权力分散，单一角色无法完成全流程操作
2. **全程留痕**：所有操作都有详细记录，可追溯
3. **自动预警**：价格异常自动预警，防止价格舞弊
4. **黑名单拦截**：违规供应商无法准入
5. **合规性**：符合GSP规范要求，操作日志保留5年

## 十、实施步骤

1. **执行数据库脚本**：
   - 运行 `create_supplier_approval_tables.sql` 创建审批流程相关表
   - 运行 `add_supplier_approval_permissions.sql` 初始化权限和角色权限配置

2. **部署后端代码**：
   - 包含审批流程、价格预警、黑名单等功能
   - 所有Controller已更新为使用权限标签而非硬编码角色ID

3. **验证权限配置**：
   - 检查各角色的权限分配是否正确
   - 验证权限拦截器是否正常工作

4. **初始化数据**：
   - 配置价格预警阈值、维护参考价格
   - 初始化价格预警全局配置

5. **前端开发**：
   - 开发审批流程界面、价格预警展示、审批日志查询
   - 更新权限检查逻辑，使用权限代码而非角色ID

6. **测试验证**：
   - 测试完整的审批流程
   - 验证权限控制和预警功能
   - 测试各角色的权限是否正确

## 十一、注意事项

1. **权限配置**：
   - 严格按照权限标签配置，不依赖硬编码角色ID
   - 通过 `add_supplier_approval_permissions.sql` 初始化权限
   - 支持通过用户直接权限实现特殊配置

2. **角色职责**：
   - 系统管理员不参与业务审批，只负责系统维护
   - 超级管理员主要用于测试，不应用于日常业务操作
   - 采购专员和仓库管理员分工明确，相互制衡

3. **价格预警阈值**：根据实际情况调整预警阈值，避免误报

4. **黑名单维护**：及时更新黑名单，确保违规供应商无法准入

5. **审批时效**：建议设置审批时效，避免审批流程过长

6. **数据备份**：定期备份审批数据和操作日志，确保数据安全

## 十二、相关文档

- `Optimized_Approval_Process_Guide.md` - 优化后的审批流程与权限配置指南（详细说明）
- `Complete_Price_Management_Solution.md` - 完整价格管理方案

