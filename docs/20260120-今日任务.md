# CDIOM 系统代码检查任务清单（2026-01-20）

## 📊 检查概览

**检查时间**：2026年1月20日  
**检查范围**：前后端所有代码  
**总体状态**：系统整体完成度约 92-96%，核心功能已实现，但存在一些需要优化的问题

---

## 🔴 P0 - 紧急问题（必须立即修复）

### 1. 前端生产环境console日志清理 ⚠️ **安全/性能问题**

**问题描述**：
- 前端代码中存在大量 `console.log`、`console.error`、`console.warn` 调用（共61处）
- 生产环境会暴露调试信息，可能泄露敏感数据
- 影响性能（console输出有性能开销）

**影响范围**：
- `cdiom_frontend/src/pages/BackendMonitor.jsx` - 5处
- `cdiom_frontend/src/pages/Dashboard.jsx` - 8处
- `cdiom_frontend/src/pages/DrugManagement.jsx` - 4处
- `cdiom_frontend/src/pages/OutboundManagement.jsx` - 8处
- 其他多个页面文件

**修复建议**：
1. 创建统一的日志工具类，根据环境变量控制日志输出
2. 开发环境保留console输出，生产环境禁用
3. 使用 `process.env.NODE_ENV === 'development'` 判断环境
4. 或使用 `vite.config.js` 的 `define` 配置在生产构建时移除console

**预计时间**：1-2小时  
**优先级**：🔴 P0 - 紧急

**修复示例**：
```javascript
// 创建 utils/logger.js
const isDev = import.meta.env.DEV;
export const logger = {
  log: (...args) => isDev && console.log(...args),
  error: (...args) => isDev && console.error(...args),
  warn: (...args) => isDev && console.warn(...args),
};
```

---

### 2. 文件上传安全性增强 ⚠️ **安全漏洞**

**问题位置**：
- `cdiom_backend/src/main/java/com/cdiom/backend/controller/FileUploadController.java`

**问题描述**：
- 仅通过文件扩展名验证文件类型，存在安全风险
- 攻击者可以伪造扩展名（如 `malware.exe.jpg`）
- 未验证文件内容的MIME类型
- 未检查文件魔数（Magic Number）

**当前代码**：
```java
// 第59行：仅检查扩展名
String extension = originalFilename.substring(originalFilename.lastIndexOf(".")).toLowerCase();
String[] allowedExtensions = {".jpg", ".jpeg", ".png", ".gif", ".bmp", ".webp", ".pdf", ".doc", ".docx"};
```

**修复建议**：
1. 使用 `Files.probeContentType()` 或 `Tika` 库检测真实MIME类型
2. 验证文件魔数（文件头字节）
3. 限制文件大小（已有，但需确认）
4. 对上传的文件进行病毒扫描（可选，生产环境建议）
5. 限制上传目录的访问权限
6. 生成随机文件名（已有UUID，但需确认路径遍历防护）

**预计时间**：2-3小时  
**优先级**：🔴 P0 - 紧急

**修复示例**：
```java
// 检测真实MIME类型
String contentType = Files.probeContentType(filePath);
if (!isAllowedMimeType(contentType)) {
    throw new RuntimeException("不允许的文件类型");
}

// 验证文件魔数
byte[] fileHeader = new byte[8];
file.getInputStream().read(fileHeader);
if (!isValidFileHeader(fileHeader, extension)) {
    throw new RuntimeException("文件类型与扩展名不匹配");
}
```

---

### 3. 部分Controller缺少参数验证注解 ⚠️ **数据完整性**

**问题描述**：
- 部分Controller方法缺少 `@Valid` 注解和参数验证
- 可能导致无效数据进入Service层
- 增加系统异常风险

**影响范围**：
- 仅3个Controller使用了验证注解（`SysUserController`、`SupplierController`、`SuperAdminController`）
- 其他Controller（如 `DrugInfoController`、`PurchaseOrderController`、`OutboundApplyController` 等）可能缺少验证

**修复建议**：
1. 检查所有Controller的POST/PUT方法
2. 为请求参数添加 `@Valid` 注解
3. 创建或完善DTO类，添加验证注解（`@NotBlank`、`@NotNull`、`@Size`、`@Pattern` 等）
4. 参考已实现的 `SysUserController` 和 `SupplierController` 的模式

**预计时间**：3-4小时  
**优先级**：🔴 P0 - 紧急

**需要检查的Controller**：
- `DrugInfoController` - 药品创建/更新
- `PurchaseOrderController` - 订单创建/更新
- `OutboundApplyController` - 出库申请创建
- `InboundRecordController` - 入库记录创建
- `InventoryAdjustmentController` - 库存调整创建
- `SupplierDrugController` - 供应商药品关联
- 其他业务Controller

---

## 🟡 P1 - 重要优化（建议尽快完成）

### 4. 性能优化：检查N+1查询问题 ⚠️ **性能问题**

**问题描述**：
- 可能存在N+1查询问题，导致数据库查询次数过多
- 影响系统性能，特别是在数据量大的情况下

**潜在问题位置**：
- `InventoryServiceImpl.getInventoryPage()` - 第80-90行，特殊药品筛选时先查询所有药品再筛选
- 其他Service中可能存在类似问题

**当前代码**：
```java
// 第80-90行：可能存在N+1问题
if (isSpecial != null) {
    LambdaQueryWrapper<DrugInfo> drugWrapper = new LambdaQueryWrapper<>();
    drugWrapper.eq(DrugInfo::getIsSpecial, isSpecial);
    List<DrugInfo> drugs = drugInfoMapper.selectList(drugWrapper);  // 查询所有特殊药品
    if (!drugs.isEmpty()) {
        List<Long> drugIds = drugs.stream().map(DrugInfo::getId).collect(Collectors.toList());
        wrapper.in(Inventory::getDrugId, drugIds);  // 使用IN查询
    }
}
```

**修复建议**：
1. 使用JOIN查询替代多次查询
2. 使用MyBatis-Plus的关联查询功能
3. 添加适当的数据库索引
4. 使用批量查询替代循环查询

**预计时间**：2-3小时  
**优先级**：🟡 P1 - 重要

---

### 5. 数据库索引优化检查 ⚠️ **性能问题**

**问题描述**：
- 需要检查所有查询条件字段是否有适当的索引
- 缺少索引会导致查询性能下降

**需要检查的字段**：
- 所有外键字段（已有，需确认）
- 所有查询条件字段（如 `status`、`create_time`、`update_time` 等）
- 所有排序字段
- 组合查询字段（如 `drug_id + batch_number`）

**修复建议**：
1. 分析慢查询日志
2. 检查所有WHERE、ORDER BY、GROUP BY字段是否有索引
3. 为常用查询组合创建复合索引
4. 定期监控索引使用情况

**预计时间**：2-3小时  
**优先级**：🟡 P1 - 重要

---

### 6. 错误处理完善 ⚠️ **系统健壮性**

**问题描述**：
- 部分Service方法可能缺少异常处理
- 某些边界情况可能未处理

**需要检查的内容**：
1. 所有Service方法的异常处理是否完整
2. 空值检查是否充分
3. 边界条件是否处理（如空列表、null值等）
4. 事务回滚是否正确配置

**修复建议**：
1. 检查所有Service实现类
2. 添加必要的空值检查
3. 确保所有异常都被正确捕获和处理
4. 添加详细的错误日志

**预计时间**：3-4小时  
**优先级**：🟡 P1 - 重要

---

## 🟢 P2 - 优化建议（可选，有时间再处理）

### 7. 代码质量优化

**问题描述**：
- 可能存在未使用的导入
- 可能存在重复代码
- 代码注释可能不够完善

**修复建议**：
1. 使用IDE的代码检查功能清理未使用的导入
2. 提取公共方法，减少重复代码
3. 完善JavaDoc注释
4. 统一代码风格

**预计时间**：2-3小时  
**优先级**：🟢 P2 - 可选

---

### 8. 前端代码优化

**问题描述**：
- 部分组件可能存在性能问题（如不必要的重渲染）
- 可能存在内存泄漏风险（如事件监听器未清理）

**修复建议**：
1. 使用React DevTools检查组件性能
2. 使用 `useMemo`、`useCallback` 优化性能
3. 确保所有事件监听器在组件卸载时清理
4. 检查是否有内存泄漏

**预计时间**：2-3小时  
**优先级**：🟢 P2 - 可选

---

### 9. 文档完善

**问题描述**：
- API文档可能需要更新
- 使用说明可能需要补充
- 部署文档可能需要完善

**修复建议**：
1. 更新API接口文档
2. 完善README.md
3. 添加部署指南
4. 添加故障排查指南

**预计时间**：2-3小时  
**优先级**：🟢 P2 - 可选

---

### 10. 测试覆盖

**问题描述**：
- 单元测试覆盖率可能不足
- 集成测试可能缺失

**修复建议**：
1. 为关键业务逻辑添加单元测试
2. 添加集成测试
3. 使用测试覆盖率工具检查

**预计时间**：4-6小时  
**优先级**：🟢 P2 - 可选

---

## 📋 任务优先级总结

| 优先级 | 任务 | 预计时间 | 紧急程度 | 状态 |
|--------|------|----------|----------|------|
| P0 | 前端console日志清理 | 1-2小时 | 🔴 紧急 | ⏳ 待处理 |
| P0 | 文件上传安全性增强 | 2-3小时 | 🔴 紧急 | ⏳ 待处理 |
| P0 | Controller参数验证完善 | 3-4小时 | 🔴 紧急 | ⏳ 待处理 |
| P1 | N+1查询问题优化 | 2-3小时 | 🟡 重要 | ⏳ 待处理 |
| P1 | 数据库索引优化 | 2-3小时 | 🟡 重要 | ⏳ 待处理 |
| P1 | 错误处理完善 | 3-4小时 | 🟡 重要 | ⏳ 待处理 |
| P2 | 代码质量优化 | 2-3小时 | 🟢 可选 | ⏳ 待处理 |
| P2 | 前端代码优化 | 2-3小时 | 🟢 可选 | ⏳ 待处理 |
| P2 | 文档完善 | 2-3小时 | 🟢 可选 | ⏳ 待处理 |
| P2 | 测试覆盖 | 4-6小时 | 🟢 可选 | ⏳ 待处理 |

**总计预计时间**：
- P0任务：6-9小时
- P1任务：7-10小时
- P2任务：10-15小时
- **总计**：23-34小时

---

## ✅ 已验证的安全措施（无需修改）

### 1. SQL注入防护 ✅
- 使用 MyBatis-Plus 的 `LambdaQueryWrapper`，所有查询都是参数化查询
- 没有发现直接拼接SQL字符串的情况

### 2. 密码加密 ✅
- 使用 BCrypt 加密，强度10轮
- 密码不会明文存储

### 3. 权限控制 ✅
- 使用 `@RequiresPermission` 注解进行权限控制
- 权限拦截器已实现

### 4. 事务管理 ✅
- 关键业务操作都使用了 `@Transactional` 注解
- 异常回滚配置正确

### 5. 登录锁定机制 ✅
- 已实现登录失败锁定机制
- 连续失败5次锁定1小时
- 使用编程式事务确保失败次数持久化

### 6. 单号生成并发安全 ✅
- 已使用数据库唯一索引 + 重试机制
- 解决了并发场景下单号重复问题

### 7. 库存操作并发安全 ✅
- 使用悲观锁（SELECT ... FOR UPDATE）
- 使用原子更新操作（INSERT ... ON DUPLICATE KEY UPDATE）

---

## 📝 注意事项

1. **测试要求**：
   - 所有P0和P1修复必须进行充分测试
   - 文件上传安全性修复需要测试各种文件类型
   - 参数验证修复需要测试边界条件和异常情况

2. **代码规范**：
   - 遵循现有代码风格
   - 添加必要的注释和日志
   - 更新相关文档

3. **文档更新**：
   - 修复后更新相关文档
   - 如有新功能，更新 `README.md`
   - 更新API文档

4. **部署前检查**：
   - 确保所有P0问题已修复
   - 进行完整的回归测试
   - 检查生产环境配置

---

## 📅 计划日期

**创建时间**：2026年1月20日  
**建议完成时间**：
- P0任务：1-2天内完成
- P1任务：3-5天内完成
- P2任务：根据实际情况安排

---

## 📈 完成情况统计

**总体完成度**：约 92-96%

**已解决问题**：
- ✅ 登录锁定机制（已完成）
- ✅ 单号生成并发问题（已完成）
- ✅ 库存操作并发安全（已完成）
- ✅ 出库逻辑FIFO批次选择（已完成）
- ✅ 数据验证和异常处理（部分完成）

**待解决问题**：
- ⏳ 前端console日志清理（P0）
- ⏳ 文件上传安全性增强（P0）
- ⏳ Controller参数验证完善（P0）
- ⏳ N+1查询问题优化（P1）
- ⏳ 数据库索引优化（P1）
- ⏳ 错误处理完善（P1）
- ⏳ 代码质量优化（P2）
- ⏳ 前端代码优化（P2）
- ⏳ 文档完善（P2）
- ⏳ 测试覆盖（P2）

---

## 🔍 检查方法说明

本次检查通过以下方式完成：
1. **代码搜索**：使用语义搜索查找潜在问题
2. **模式匹配**：使用grep查找特定模式（如console.log、@Transactional等）
3. **文件审查**：阅读关键代码文件
4. **文档参考**：参考已有的问题报告和修复文档

**检查工具**：
- 代码语义搜索
- 正则表达式搜索
- 文件内容分析
- 依赖关系分析

---

**备注**：本任务清单基于2026年1月20日的代码检查结果生成。建议优先处理P0紧急问题，确保系统安全性和稳定性。

