# 药品价格协议管理解决方案

## 一、问题背景

在药品出入库管理系统中，如何确保管理员设定的价格与供应商协议完全一致，避免误操作导致的价格错误，是一个重要的业务需求。

## 二、解决方案概述

本方案通过以下机制确保价格与协议的一致性：

1. **协议文件存档**：支持上传协议电子版或扫描件到系统
2. **协议关联**：价格设定时关联具体的协议文件
3. **价格历史记录**：记录每次价格变更的完整历史
4. **操作日志**：记录所有价格相关操作，确保可追溯
5. **协议有效期管理**：支持协议生效日期和到期日期

## 三、核心功能

### 3.1 协议文件管理

#### 3.1.1 文件上传
- **支持格式**：图片（jpg, jpeg, png, gif, bmp, webp）和文档（pdf, doc, docx）
- **文件大小限制**：最大10MB
- **存储方式**：按日期分类存储（yyyy/MM/dd目录结构）
- **文件命名**：使用UUID生成唯一文件名，防止冲突

#### 3.1.2 协议信息管理
- **协议编号**：唯一标识协议
- **协议名称**：协议描述
- **协议文件**：上传的协议文件URL
- **协议类型**：PRICE（价格协议）/ FRAMEWORK（框架协议）
- **生效日期**：协议开始生效的日期
- **到期日期**：协议到期日期（可选）
- **协议价格**：协议中约定的单价
- **货币单位**：默认CNY（人民币）

### 3.2 价格设定流程

#### 3.2.1 标准流程
1. **协议签订**：供应商与医院签订纸质协议，提供价格表
2. **协议上传**：管理员将协议电子版或扫描件上传到系统
3. **协议录入**：管理员在系统中创建协议记录，填写协议信息
4. **价格设定**：管理员根据协议设定价格，并关联协议ID
5. **历史记录**：系统自动记录价格变更历史
6. **操作日志**：系统自动记录操作日志

#### 3.2.2 价格更新流程
1. **协议变更**：供应商提供新的协议或价格调整通知
2. **新协议上传**：管理员上传新协议文件
3. **协议录入**：创建新的协议记录
4. **价格更新**：更新价格，关联新协议ID，填写变更原因
5. **历史记录**：系统记录变更前后价格对比
6. **操作日志**：记录操作人、操作时间、IP地址等信息

### 3.3 价格历史记录

每次价格变更都会记录以下信息：
- **变更前价格**：变更前的单价
- **变更后价格**：变更后的单价
- **变更原因**：价格变更的原因说明
- **变更类型**：
  - MANUAL：手动修改
  - AGREEMENT：协议更新
  - AUTO：自动调整
- **关联协议**：关联的协议ID
- **操作人信息**：操作人ID、姓名
- **操作时间**：精确到秒
- **IP地址**：操作时的IP地址

### 3.4 操作日志

所有价格相关操作都会记录操作日志，包括：
- **操作模块**：药品价格管理 / 价格协议管理
- **操作类型**：INSERT / UPDATE / DELETE
- **操作内容**：详细的操作描述
- **操作人**：用户ID、用户名
- **操作时间**：精确到秒
- **IP地址**：操作时的IP地址
- **请求参数**：完整的请求参数（JSON格式）
- **操作状态**：成功 / 失败
- **错误信息**：失败时的错误信息

## 四、数据库设计

### 4.1 价格协议表（supplier_drug_agreement）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键ID |
| supplier_id | BIGINT | 供应商ID |
| drug_id | BIGINT | 药品ID |
| agreement_number | VARCHAR(100) | 协议编号 |
| agreement_name | VARCHAR(200) | 协议名称 |
| agreement_file_url | VARCHAR(500) | 协议文件URL |
| agreement_type | VARCHAR(20) | 协议类型 |
| effective_date | DATE | 生效日期 |
| expiry_date | DATE | 到期日期 |
| unit_price | DECIMAL(10,2) | 协议约定的单价 |
| currency | VARCHAR(10) | 货币单位 |
| remark | VARCHAR(500) | 备注 |
| create_by | BIGINT | 创建人ID |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |
| deleted | TINYINT | 逻辑删除标志 |

### 4.2 价格历史记录表（supplier_drug_price_history）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键ID |
| supplier_id | BIGINT | 供应商ID |
| drug_id | BIGINT | 药品ID |
| agreement_id | BIGINT | 关联的协议ID |
| price_before | DECIMAL(10,2) | 变更前价格 |
| price_after | DECIMAL(10,2) | 变更后价格 |
| change_reason | VARCHAR(500) | 变更原因 |
| change_type | VARCHAR(20) | 变更类型 |
| operator_id | BIGINT | 操作人ID |
| operator_name | VARCHAR(50) | 操作人姓名 |
| operation_time | DATETIME | 操作时间 |
| ip_address | VARCHAR(50) | 操作IP地址 |
| remark | VARCHAR(500) | 备注 |

### 4.3 供应商-药品关联表扩展

在 `supplier_drug` 表中新增字段：
- `current_agreement_id`：当前生效的协议ID

## 五、API接口

### 5.1 价格协议管理接口

- `POST /api/v1/supplier-drug-agreements` - 创建价格协议
- `GET /api/v1/supplier-drug-agreements/{id}` - 根据ID查询协议
- `GET /api/v1/supplier-drug-agreements/current` - 查询当前生效的协议
- `GET /api/v1/supplier-drug-agreements/list` - 查询所有协议
- `PUT /api/v1/supplier-drug-agreements/{id}` - 更新协议
- `DELETE /api/v1/supplier-drug-agreements/{id}` - 删除协议

### 5.2 价格更新接口（增强版）

- `PUT /api/v1/supplier-drugs/price` - 更新价格（支持协议关联）

请求参数：
```json
{
  "supplierId": 1,
  "drugId": 1,
  "unitPrice": 100.00,
  "agreementId": 1,  // 可选：关联的协议ID
  "changeReason": "根据新协议调整价格"  // 可选：变更原因
}
```

### 5.3 价格历史查询接口

- `GET /api/v1/supplier-drug-price-history/list` - 查询价格历史
- `GET /api/v1/supplier-drug-price-history/agreement/{agreementId}` - 根据协议ID查询价格历史

## 六、使用场景

### 场景1：初始价格设定

1. 供应商与医院签订协议，提供价格表
2. 管理员将协议文件上传到系统
3. 管理员创建协议记录，填写协议信息
4. 管理员根据协议设定价格，关联协议ID
5. 系统自动记录价格历史 and 操作日志

### 场景2：价格调整

1. 供应商提供新的价格调整通知或新协议
2. 管理员上传新协议文件（如有）
3. 管理员创建新协议记录（如有）
4. 管理员更新价格，关联新协议ID，填写变更原因
5. 系统自动记录价格变更历史（包含变更前后对比）
6. 系统自动记录操作日志

### 场景3：价格查询与追溯

1. 查看当前价格及关联的协议
2. 查看协议文件（电子版或扫描件）
3. 查看价格变更历史
4. 查看操作日志，追溯价格变更的完整过程

## 七、安全保障措施

### 7.1 权限控制
- 只有具有 `drug:manage` 权限的用户可以创建/更新/删除协议和价格
- 具有 `drug:view` 权限的用户可以查看协议和价格历史

### 7.2 数据完整性
- 协议文件必须上传才能关联价格
- 价格更新时必须填写变更原因（建议）
- 所有操作都记录操作日志，不可删除

### 7.3 可追溯性
- 价格历史记录永久保存
- 操作日志保留5年（符合GSP规范）
- 所有价格变更都可以追溯到具体的协议和操作人

## 八、优势总结

1. **确保一致性**：通过协议关联，确保价格与协议一致
2. **防止误操作**：操作日志和历史记录可以及时发现和纠正错误
3. **完整追溯**：所有价格变更都有完整的记录，可追溯
4. **协议存档**：协议文件电子化存档，便于查阅
5. **合规性**：符合GSP规范要求，操作日志保留5年

## 九、实施步骤

1. **执行数据库脚本**：运行 `create_price_agreement_tables.sql`
2. **部署后端代码**：包含新增的实体类、Mapper、Service和Controller
3. **扩展文件上传**：已支持PDF、DOC等协议文件格式
4. **前端开发**：开发协议管理和价格历史查询界面
5. **测试验证**：测试完整的价格设定和更新流程

## 十、注意事项

1. **协议文件格式**：建议使用PDF格式，便于长期保存和查看
2. **协议编号**：建议使用统一的编号规则，便于管理
3. **变更原因**：价格更新时建议填写详细的变更原因
4. **协议有效期**：及时更新协议到期日期，系统可以提醒
5. **数据备份**：协议文件和数据库需要定期备份

