# CDIOM 数据库脚本说明

本目录包含CDIOM系统的所有数据库脚本文件，用于数据库初始化、数据修复、权限配置等操作。

## 📋 脚本文件列表

### 🚀 数据库初始化脚本

#### 1. `init_simple.sql` ⭐ **推荐使用**
- **用途**：简化版数据库初始化脚本（推荐）
- **功能**：
  - 创建数据库 `cdiom_db`
  - 创建所有19张表（系统表、权限表、业务表、扩展表）
  - 初始化基础数据（5个角色、1个管理员用户、4个系统配置、2个通知公告）
- **使用场景**：首次部署系统时使用
- **执行顺序**：第一个执行
- **注意事项**：已包含所有表的创建语句，推荐直接使用此文件

#### 2. `init.sql`
- **用途**：完整版数据库初始化脚本（带详细注释）
- **功能**：与 `init_simple.sql` 功能相同，但包含更详细的注释说明
- **使用场景**：需要查看详细注释时使用
- **执行顺序**：第一个执行（与 `init_simple.sql` 二选一）

#### 3. `cdiom_db_complete.sql`
- **用途**：完整数据库脚本（包含所有表结构和数据）
- **功能**：创建数据库、所有表结构、初始化数据
- **使用场景**：完整数据库重建
- **执行顺序**：第一个执行（与 `init_simple.sql` 二选一）

#### 4. `init_business_tables.sql`
- **用途**：业务表创建脚本
- **功能**：仅创建业务相关的表（供应商、药品信息、库存、采购订单、入库记录、出库申请等）
- **使用场景**：如果已执行系统表初始化，只需创建业务表时使用
- **执行顺序**：在系统表创建之后执行
- **注意事项**：`init_simple.sql` 已包含此脚本内容，通常不需要单独执行

### 🔐 权限配置脚本

#### 5. `init_permissions.sql`
- **用途**：权限数据初始化脚本
- **功能**：
  - 初始化系统权限数据（用户管理、角色管理、药品管理、配置管理、通知管理、日志查看等权限）
  - 配置角色权限关联（系统管理员、仓库管理员等角色的权限分配）
- **使用场景**：
  - 首次部署系统时执行
  - 权限系统升级后需要重新初始化权限数据
- **执行顺序**：在数据库初始化之后执行
- **注意事项**：使用 `ON DUPLICATE KEY UPDATE` 避免重复插入

### 🔧 数据修复脚本

#### 6. `fix_chinese_data.sql`
- **用途**：修复中文数据乱码问题
- **功能**：更新系统角色、系统配置、通知公告等表的中文数据
- **使用场景**：当数据库中的中文数据显示为问号或乱码时使用
- **执行顺序**：在数据库初始化之后执行
- **注意事项**：仅修复数据内容，不修改字符集

#### 7. `fix_chinese_utf8mb4.sql`
- **用途**：修复中文数据（简化版）
- **功能**：快速修复角色、配置、通知的中文数据
- **使用场景**：中文数据乱码时使用（简化版）
- **执行顺序**：在数据库初始化之后执行

#### 8. `fix_database_charset.sql`
- **用途**：修复数据库字符集问题
- **功能**：
  - 修改数据库字符集为 `utf8mb4`
  - 修改所有表的字符集和排序规则
  - 修改所有字段的字符集
- **使用场景**：当数据库、表或字段的字符集不是 `utf8mb4` 导致中文乱码时使用
- **执行顺序**：在数据库初始化之后执行
- **注意事项**：此脚本会修改数据库和表的结构，执行前请备份

#### 9. `fix_operation_log_permission.sql`
- **用途**：修复操作日志权限问题
- **功能**：从仓库管理员角色中移除操作日志查看权限，确保只有系统管理员可以查看操作日志
- **使用场景**：当仓库管理员不应该有操作日志查看权限时使用
- **执行顺序**：在权限初始化之后执行
- **注意事项**：此脚本会删除权限关联，执行前请确认

### 📦 数据导入脚本

#### 10. `drug_info_insert.sql`
- **用途**：药品信息数据导入脚本
- **功能**：批量导入药品信息数据到 `drug_info` 表
- **使用场景**：
  - 系统初始化时导入示例药品数据
  - 批量导入药品信息
- **执行顺序**：在数据库初始化之后执行
- **注意事项**：
  - 使用 `INSERT IGNORE` 或事务处理避免重复数据
  - 确保 `supplier_id` 和 `create_by` 的值在对应表中存在，或保持为 NULL
  - 确保数据库字符集为 `utf8mb4`

### 🔑 用户管理脚本

#### 11. `update_admin_password.sql`
- **用途**：更新超级管理员密码
- **功能**：将超级管理员（admin）的密码更新为新的BCrypt加密值
- **使用场景**：
  - 忘记管理员密码时重置密码
  - 需要修改管理员密码时使用
- **执行顺序**：在数据库初始化之后执行
- **注意事项**：
  - 密码必须是BCrypt加密后的值，不能使用明文
  - 执行后需要验证密码是否正确
  - 建议执行后立即修改密码

#### 12. `init_super_admin.sql` ⭐ **新增**
- **用途**：超级管理员角色和用户初始化脚本
- **功能**：
  - 创建超级管理员角色（roleId=6，角色代码：SUPER_ADMIN_TEST）
  - 创建超级管理员用户（username=super_admin，默认状态为停用）
  - 超级管理员拥有所有权限（系统功能和业务功能），主要用于系统测试和维护
- **使用场景**：
  - 系统测试阶段启用超级管理员进行功能测试
  - 系统维护更新时重新启用超级管理员
  - 系统投入使用后应停用该用户
- **执行顺序**：在数据库初始化之后执行
- **注意事项**：
  - 超级管理员默认状态为停用（status=0），需要通过邮箱验证码启用
  - 启用/停用操作需要系统管理员权限，并通过163邮箱发送验证码验证
  - 超级管理员拥有所有权限，请谨慎使用

---

## 📝 使用指南

### 首次部署系统

**推荐流程**：
1. 执行 `init_simple.sql` - 初始化数据库和所有表
2. 执行 `init_permissions.sql` - 初始化权限数据
3. （可选）执行 `drug_info_insert.sql` - 导入示例药品数据

### 修复中文乱码问题

**如果数据乱码**：
1. 先执行 `fix_database_charset.sql` - 修复数据库和表的字符集
2. 再执行 `fix_chinese_data.sql` - 修复数据内容

### 权限问题修复

**如果权限配置有问题**：
1. 执行 `init_permissions.sql` - 重新初始化权限数据
2. 或执行 `fix_operation_log_permission.sql` - 修复特定权限问题

### 重置管理员密码

**如果忘记管理员密码**：
1. 执行 `update_admin_password.sql` - 重置密码
2. 使用新密码登录后立即修改密码

---

## ⚠️ 注意事项

1. **备份数据**：执行任何脚本前，请先备份数据库
2. **字符集**：确保数据库、表和字段的字符集都是 `utf8mb4`
3. **执行顺序**：按照脚本的依赖关系执行，先执行初始化脚本，再执行修复脚本
4. **权限脚本**：`init_permissions.sql` 使用 `ON DUPLICATE KEY UPDATE`，可以重复执行
5. **数据导入**：`drug_info_insert.sql` 包含大量数据，执行时间可能较长

---

## 📊 脚本分类

### 初始化脚本（首次部署）
- `init_simple.sql` ⭐
- `init.sql`
- `cdiom_db_complete.sql`
- `init_business_tables.sql`
- `init_permissions.sql`
- `init_super_admin.sql` ⭐ **新增**

### 修复脚本（问题修复）
- `fix_chinese_data.sql`
- `fix_chinese_utf8mb4.sql`
- `fix_database_charset.sql`
- `fix_operation_log_permission.sql`

### 数据导入脚本
- `drug_info_insert.sql`

### 用户管理脚本
- `update_admin_password.sql`
- `init_super_admin.sql` ⭐ **新增**

---

**最后更新**：2026年1月13日

